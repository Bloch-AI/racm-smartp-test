{% extends "base.html" %}

{% block title %}Admin - SmartPapers{% endblock %}

{% block page_styles %}
/* Tab styling */
.admin-tab-btn {
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #64748b;
    border-bottom: 2px solid transparent;
    transition: all 0.15s ease;
}
.admin-tab-btn:hover {
    color: #334155;
}
.admin-tab-btn.active {
    color: #008bd1;
    border-bottom-color: #008bd1;
}

/* Table styling */
.admin-table {
    width: 100%;
}
.admin-table th {
    text-align: left;
    padding: 0.75rem 1rem;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #64748b;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
}
.admin-table td {
    padding: 0.875rem 1rem;
    font-size: 0.875rem;
    color: #334155;
    border-bottom: 1px solid #f1f5f9;
}
.admin-table tr:hover td {
    background: #f8fafc;
}

/* Badge styling */
.badge {
    display: inline-flex;
    align-items: center;
    padding: 0.125rem 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: 9999px;
}
.badge-green { background: #dcfce7; color: #15803d; }
.badge-red { background: #fee2e2; color: #b91c1c; }
.badge-blue { background: #dbeafe; color: #1d4ed8; }
.badge-slate { background: #f1f5f9; color: #475569; }
.badge-amber { background: #fef3c7; color: #92400e; }
{% endblock %}

{% block content %}
<main class="flex-1 py-6">
    <div class="mx-auto px-4 sm:px-6 max-w-7xl">
        <!-- Header -->
        <div class="mb-6">
            <h1 class="text-xl font-semibold text-slate-900 font-display">Admin Console</h1>
            <p class="text-sm text-slate-500">Manage users and audit access</p>
        </div>

        <!-- Tab Bar -->
        <div class="flex items-center justify-between border-b border-slate-200 mb-6">
            <div class="flex">
                <button class="admin-tab-btn active" data-tab="users" onclick="switchAdminTab('users')">
                    <span class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        Users
                    </span>
                </button>
                <button class="admin-tab-btn" data-tab="audits" onclick="switchAdminTab('audits')">
                    <span class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Audit Access
                    </span>
                </button>
                <button class="admin-tab-btn" data-tab="records" onclick="switchAdminTab('records')">
                    <span class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        Record Overrides
                    </span>
                </button>
            </div>
            <div class="pb-2">
                <button id="addUserBtn" onclick="openCreateUserModal()" class="btn btn-primary text-sm">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                    </svg>
                    Add User
                </button>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="tab-content">
            <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Role</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table">
                        <tr><td colspan="5" class="text-center text-slate-400 py-8">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Audits Tab -->
        <div id="audits-tab" class="tab-content hidden">
            <div class="grid gap-4">
                <div id="audits-list" class="space-y-3">
                    <div class="text-center text-slate-400 py-8">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Records Tab -->
        <div id="records-tab" class="tab-content hidden">
            <!-- Records on Hold Section -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2">
                    <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                    Records on Admin Hold
                </h2>
                <div id="records-on-hold" class="bg-white rounded-lg border border-slate-200 overflow-hidden">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>ID</th>
                                <th>Audit</th>
                                <th>Locked By</th>
                                <th>Locked At</th>
                                <th>Reason</th>
                                <th class="text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="hold-records-table">
                            <tr><td colspan="7" class="text-center text-slate-400 py-8">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Signed Off Records Section -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                    Signed Off Records
                </h2>
                <div id="signed-off-records" class="bg-white rounded-lg border border-slate-200 overflow-hidden">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>ID</th>
                                <th>Audit</th>
                                <th>Signed Off By</th>
                                <th>Signed Off At</th>
                                <th class="text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="signedoff-records-table">
                            <tr><td colspan="6" class="text-center text-slate-400 py-8">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Audit Log Section -->
            <div>
                <h2 class="text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2">
                    <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                    Recent Workflow Changes
                </h2>
                <div id="audit-log" class="bg-white rounded-lg border border-slate-200 overflow-hidden">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Type</th>
                                <th>Record ID</th>
                                <th>Action</th>
                                <th>User</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="audit-log-table">
                            <tr><td colspan="6" class="text-center text-slate-400 py-8">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- User Modal -->
<div id="userModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
        <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between">
            <h3 id="userModalTitle" class="text-base font-semibold text-slate-900">Add User</h3>
            <button onclick="closeUserModal()" class="text-slate-400 hover:text-slate-600">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <form id="userForm" onsubmit="saveUser(event)" class="p-6 space-y-4">
            <input type="hidden" id="userId">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Name</label>
                <input type="text" id="userName" required class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                <input type="email" id="userEmail" required class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">
                    Password <span id="passwordHint" class="text-slate-400 font-normal">(required)</span>
                </label>
                <input type="password" id="userPassword" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
            </div>
            <div class="flex items-center gap-6">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="userIsActive" checked class="w-4 h-4 text-primary-600 rounded border-slate-300">
                    <span class="text-sm text-slate-700">Active</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="userIsAdmin" class="w-4 h-4 text-primary-600 rounded border-slate-300">
                    <span class="text-sm text-slate-700">Administrator</span>
                </label>
            </div>
        </form>
        <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex justify-end gap-2 rounded-b-xl">
            <button onclick="closeUserModal()" class="px-5 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 rounded-full">Cancel</button>
            <button onclick="document.getElementById('userForm').requestSubmit()" class="px-5 py-2 text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 rounded-full">Save</button>
        </div>
    </div>
</div>

<!-- Membership Modal -->
<div id="membershipModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4">
        <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between">
            <h3 id="membershipModalTitle" class="text-base font-semibold text-slate-900">Manage Access</h3>
            <button onclick="closeMembershipModal()" class="text-slate-400 hover:text-slate-600">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="p-6">
            <input type="hidden" id="membershipAuditId">

            <!-- Auditors Section -->
            <div class="mb-4">
                <h4 class="text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
                    <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                    Auditors
                </h4>
                <div id="currentAuditors" class="space-y-2 max-h-32 overflow-y-auto">
                    <div class="text-sm text-slate-400">Loading...</div>
                </div>
            </div>

            <!-- Reviewers Section -->
            <div class="mb-4">
                <h4 class="text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                    Reviewers
                </h4>
                <div id="currentReviewers" class="space-y-2 max-h-32 overflow-y-auto">
                    <div class="text-sm text-slate-400">Loading...</div>
                </div>
            </div>

            <!-- Viewers Section -->
            <div class="mb-4">
                <h4 class="text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
                    <span class="w-2 h-2 bg-slate-400 rounded-full"></span>
                    Viewers
                </h4>
                <div id="currentViewers" class="space-y-2 max-h-32 overflow-y-auto">
                    <div class="text-sm text-slate-400">Loading...</div>
                </div>
            </div>

            <!-- Add Member -->
            <div class="border-t border-slate-200 pt-4">
                <h4 class="text-sm font-medium text-slate-700 mb-3">Add Team Member</h4>
                <div class="flex gap-2">
                    <select id="addMemberUser" class="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm">
                        <option value="">Select user...</option>
                    </select>
                    <select id="addMemberRole" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
                        <option value="viewer">Viewer</option>
                        <option value="reviewer">Reviewer</option>
                        <option value="auditor" selected>Auditor</option>
                    </select>
                    <button onclick="addMember()" class="px-5 py-2 text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 rounded-full">Add</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let users = [];
let audits = [];
let roles = [];

// Tab switching
function switchAdminTab(tab) {
    document.querySelectorAll('.admin-tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    document.getElementById(tab + '-tab').classList.remove('hidden');

    // Show/hide add button
    document.getElementById('addUserBtn').style.display = tab === 'users' ? '' : 'none';

    // Load records data when switching to records tab
    if (tab === 'records') {
        loadRecordsData();
    }
}

// Load data
async function loadData() {
    const [usersRes, auditsRes, rolesRes] = await Promise.all([
        fetch('/api/admin/users'),
        fetch('/api/audits'),
        fetch('/api/admin/roles')
    ]);
    users = await usersRes.json();
    audits = await auditsRes.json();
    roles = await rolesRes.json();

    renderUsers();
    renderAudits();
}

function renderUsers() {
    const tbody = document.getElementById('users-table');
    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-slate-400 py-8">No users</td></tr>';
        return;
    }

    tbody.innerHTML = users.map(user => `
        <tr>
            <td>
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-sm font-medium text-slate-600">
                        ${user.name.charAt(0).toUpperCase()}
                    </div>
                    <span class="font-medium text-slate-900">${escapeHtml(user.name)}</span>
                </div>
            </td>
            <td class="text-slate-500">${escapeHtml(user.email)}</td>
            <td><span class="badge ${user.is_active ? 'badge-green' : 'badge-red'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
            <td><span class="badge ${user.is_admin ? 'badge-blue' : 'badge-slate'}">${user.is_admin ? 'Admin' : 'User'}</span></td>
            <td class="text-right">
                <button onclick="openEditUserModal(${user.id})" class="text-sm text-primary-600 hover:text-primary-700 font-medium">Edit</button>
                ${user.is_active
                    ? `<button onclick="toggleUserStatus(${user.id}, false)" class="text-sm text-red-600 hover:text-red-700 font-medium ml-3">Deactivate</button>`
                    : `<button onclick="toggleUserStatus(${user.id}, true)" class="text-sm text-emerald-600 hover:text-emerald-700 font-medium ml-3">Activate</button>`
                }
            </td>
        </tr>
    `).join('');
}

function renderAudits() {
    const container = document.getElementById('audits-list');
    if (audits.length === 0) {
        container.innerHTML = '<div class="text-center text-slate-400 py-8">No audits</div>';
        return;
    }

    container.innerHTML = audits.map(audit => `
        <div class="bg-white rounded-lg border border-slate-200 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="font-medium text-slate-900">${escapeHtml(audit.title)}</h3>
                    <p class="text-sm text-slate-500">${escapeHtml(audit.department || audit.audit_type || '')}</p>
                </div>
                <button onclick="openMembershipModal(${audit.id}, '${escapeHtml(audit.title)}')" class="px-4 py-1.5 text-sm font-medium text-primary-600 hover:bg-primary-50 rounded-full">
                    Manage Access
                </button>
            </div>
        </div>
    `).join('');
}

// User Modal
function openCreateUserModal() {
    document.getElementById('userModalTitle').textContent = 'Add User';
    document.getElementById('userId').value = '';
    document.getElementById('userName').value = '';
    document.getElementById('userEmail').value = '';
    document.getElementById('userPassword').value = '';
    document.getElementById('userPassword').required = true;
    document.getElementById('passwordHint').textContent = '(required)';
    document.getElementById('userIsActive').checked = true;
    document.getElementById('userIsAdmin').checked = false;
    document.getElementById('userModal').classList.remove('hidden');
    document.getElementById('userModal').classList.add('flex');
}

function openEditUserModal(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) return;

    document.getElementById('userModalTitle').textContent = 'Edit User';
    document.getElementById('userId').value = user.id;
    document.getElementById('userName').value = user.name;
    document.getElementById('userEmail').value = user.email;
    document.getElementById('userPassword').value = '';
    document.getElementById('userPassword').required = false;
    document.getElementById('passwordHint').textContent = '(leave blank to keep)';
    document.getElementById('userIsActive').checked = user.is_active;
    document.getElementById('userIsAdmin').checked = user.is_admin;
    document.getElementById('userModal').classList.remove('hidden');
    document.getElementById('userModal').classList.add('flex');
}

function closeUserModal() {
    document.getElementById('userModal').classList.add('hidden');
    document.getElementById('userModal').classList.remove('flex');
}

async function saveUser(event) {
    event.preventDefault();
    const userId = document.getElementById('userId').value;
    const data = {
        name: document.getElementById('userName').value,
        email: document.getElementById('userEmail').value,
        is_active: document.getElementById('userIsActive').checked ? 1 : 0,
        is_admin: document.getElementById('userIsAdmin').checked ? 1 : 0
    };
    const password = document.getElementById('userPassword').value;
    if (password) data.password = password;

    const res = await fetch(userId ? `/api/admin/users/${userId}` : '/api/admin/users', {
        method: userId ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });

    if (res.ok) {
        showToast(userId ? 'User updated' : 'User created', 'success');
        closeUserModal();
        loadData();
    } else {
        const err = await res.json();
        showToast(err.error || 'Error saving user', 'error');
    }
}

async function toggleUserStatus(userId, activate) {
    if (!activate && !confirm('Deactivate this user?')) return;

    const res = await fetch(`/api/admin/users/${userId}`, {
        method: activate ? 'PUT' : 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: activate ? JSON.stringify({ is_active: 1 }) : undefined
    });

    if (res.ok) {
        showToast(activate ? 'User activated' : 'User deactivated', 'success');
        loadData();
    }
}

// Membership Modal
async function openMembershipModal(auditId, auditTitle) {
    document.getElementById('membershipModalTitle').textContent = auditTitle;
    document.getElementById('membershipAuditId').value = auditId;
    document.getElementById('membershipModal').classList.remove('hidden');
    document.getElementById('membershipModal').classList.add('flex');

    // Populate user dropdown
    const select = document.getElementById('addMemberUser');
    select.innerHTML = '<option value="">Select user...</option>' +
        users.filter(u => u.is_active).map(u => `<option value="${u.id}">${escapeHtml(u.name)}</option>`).join('');

    // Load current members
    await loadMembers(auditId);
}

function closeMembershipModal() {
    document.getElementById('membershipModal').classList.add('hidden');
    document.getElementById('membershipModal').classList.remove('flex');
}

async function loadMembers(auditId) {
    const res = await fetch(`/api/admin/audits/${auditId}/team`);
    const data = await res.json();

    // Render Auditors
    const auditorsContainer = document.getElementById('currentAuditors');
    if (data.auditors && data.auditors.length > 0) {
        auditorsContainer.innerHTML = data.auditors.map(m => `
            <div class="flex items-center justify-between py-2 px-3 bg-blue-50 rounded-lg">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-medium text-slate-900">${escapeHtml(m.user_name)}</span>
                </div>
                <button onclick="removeTeamMember(${auditId}, ${m.user_id}, 'auditor')" class="text-sm text-red-600 hover:text-red-700">Remove</button>
            </div>
        `).join('');
    } else {
        auditorsContainer.innerHTML = '<div class="text-sm text-slate-400 py-2 px-3">No auditors assigned</div>';
    }

    // Render Reviewers
    const reviewersContainer = document.getElementById('currentReviewers');
    if (data.reviewers && data.reviewers.length > 0) {
        reviewersContainer.innerHTML = data.reviewers.map(m => `
            <div class="flex items-center justify-between py-2 px-3 bg-green-50 rounded-lg">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-medium text-slate-900">${escapeHtml(m.user_name)}</span>
                </div>
                <button onclick="removeTeamMember(${auditId}, ${m.user_id}, 'reviewer')" class="text-sm text-red-600 hover:text-red-700">Remove</button>
            </div>
        `).join('');
    } else {
        reviewersContainer.innerHTML = '<div class="text-sm text-slate-400 py-2 px-3">No reviewers assigned</div>';
    }

    // Render Viewers
    const viewersContainer = document.getElementById('currentViewers');
    if (data.viewers && data.viewers.length > 0) {
        viewersContainer.innerHTML = data.viewers.map(m => `
            <div class="flex items-center justify-between py-2 px-3 bg-slate-50 rounded-lg">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-medium text-slate-900">${escapeHtml(m.user_name)}</span>
                </div>
                <button onclick="removeViewer(${auditId}, ${m.user_id})" class="text-sm text-red-600 hover:text-red-700">Remove</button>
            </div>
        `).join('');
    } else {
        viewersContainer.innerHTML = '<div class="text-sm text-slate-400 py-2 px-3">No viewers assigned</div>';
    }
}

async function addMember() {
    const auditId = document.getElementById('membershipAuditId').value;
    const userId = document.getElementById('addMemberUser').value;
    const teamRole = document.getElementById('addMemberRole').value;

    if (!userId) {
        showToast('Select a user', 'error');
        return;
    }

    let endpoint, body;
    if (teamRole === 'viewer') {
        endpoint = `/api/admin/audits/${auditId}/viewers`;
        body = { user_id: parseInt(userId) };
    } else {
        endpoint = `/api/admin/audits/${auditId}/team`;
        body = { user_id: parseInt(userId), team_role: teamRole };
    }

    const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    });

    if (res.ok) {
        showToast('Member added', 'success');
        loadMembers(auditId);
        document.getElementById('addMemberUser').value = '';
    } else {
        const err = await res.json();
        showToast(err.error || 'Error adding member', 'error');
    }
}

async function removeTeamMember(auditId, userId, teamRole) {
    if (!confirm(`Remove this ${teamRole}?`)) return;

    const res = await fetch(`/api/admin/audits/${auditId}/team/${userId}/${teamRole}`, { method: 'DELETE' });

    if (res.ok) {
        showToast('Member removed', 'success');
        loadMembers(auditId);
    }
}

async function removeViewer(auditId, userId) {
    if (!confirm('Remove this viewer?')) return;

    const res = await fetch(`/api/admin/audits/${auditId}/viewers/${userId}`, { method: 'DELETE' });

    if (res.ok) {
        showToast('Viewer removed', 'success');
        loadMembers(auditId);
    }
}

// Legacy function for backward compatibility
async function removeMember(auditId, userId) {
    if (!confirm('Remove this member?')) return;

    const res = await fetch(`/api/admin/audits/${auditId}/memberships/${userId}`, { method: 'DELETE' });

    if (res.ok) {
        showToast('Member removed', 'success');
        loadMembers(auditId);
    }
}

// ==================== Records Tab Functions ====================

let recordsOnHold = [];
let signedOffRecords = [];
let auditLog = [];

async function loadRecordsData() {
    try {
        const [holdRes, logRes] = await Promise.all([
            fetch('/api/admin/records-in-hold'),
            fetch('/api/admin/audit-log')
        ]);
        recordsOnHold = await holdRes.json();
        auditLog = await logRes.json();

        // Extract signed-off records from audit log (latest entries with signed_off status)
        // We'll use the workflow summary from each audit for signed-off records
        signedOffRecords = recordsOnHold.filter(r => r.record_status === 'signed_off');
        recordsOnHold = recordsOnHold.filter(r => r.record_status === 'admin_hold');

        renderRecordsOnHold();
        renderSignedOffRecords();
        renderAuditLog();
    } catch (err) {
        console.error('Error loading records data:', err);
    }
}

function renderRecordsOnHold() {
    const tbody = document.getElementById('hold-records-table');
    if (recordsOnHold.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-slate-400 py-8">No records on hold</td></tr>';
        return;
    }

    tbody.innerHTML = recordsOnHold.map(record => `
        <tr>
            <td><span class="badge badge-blue">${escapeHtml(record.record_type || 'risk')}</span></td>
            <td class="font-mono text-sm">${escapeHtml(record.risk_id || record.issue_id || record.id)}</td>
            <td>${escapeHtml(record.audit_title || '-')}</td>
            <td>${escapeHtml(record.locked_by_name || '-')}</td>
            <td class="text-slate-500">${record.admin_locked_at ? new Date(record.admin_locked_at).toLocaleString() : '-'}</td>
            <td class="text-sm max-w-xs truncate">${escapeHtml(record.admin_lock_reason || '-')}</td>
            <td class="text-right">
                <button onclick="unlockRecord('${record.record_type || 'risk'}', ${record.id})"
                        class="text-sm text-primary-600 hover:text-primary-700 font-medium">
                    Unlock
                </button>
            </td>
        </tr>
    `).join('');
}

function renderSignedOffRecords() {
    const tbody = document.getElementById('signedoff-records-table');
    if (signedOffRecords.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-slate-400 py-8">No signed-off records</td></tr>';
        return;
    }

    tbody.innerHTML = signedOffRecords.map(record => `
        <tr>
            <td><span class="badge badge-green">${escapeHtml(record.record_type || 'risk')}</span></td>
            <td class="font-mono text-sm">${escapeHtml(record.risk_id || record.issue_id || record.id)}</td>
            <td>${escapeHtml(record.audit_title || '-')}</td>
            <td>${escapeHtml(record.signed_off_by_name || '-')}</td>
            <td class="text-slate-500">${record.signed_off_at ? new Date(record.signed_off_at).toLocaleString() : '-'}</td>
            <td class="text-right">
                <button onclick="unlockSignoff('${record.record_type || 'risk'}', ${record.id})"
                        class="text-sm text-red-600 hover:text-red-700 font-medium">
                    Unlock Sign-off
                </button>
            </td>
        </tr>
    `).join('');
}

function renderAuditLog() {
    const tbody = document.getElementById('audit-log-table');
    if (auditLog.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-slate-400 py-8">No recent changes</td></tr>';
        return;
    }

    tbody.innerHTML = auditLog.map(entry => {
        const actionBadgeClass = {
            'submit_for_review': 'badge-blue',
            'return_to_auditor': 'badge-slate',
            'sign_off': 'badge-green',
            'admin_lock': 'badge-red',
            'admin_unlock': 'badge-slate',
            'admin_unlock_signoff': 'badge-red'
        }[entry.action] || 'badge-slate';

        return `
            <tr>
                <td class="text-slate-500 text-sm">${entry.created_at ? new Date(entry.created_at).toLocaleString() : '-'}</td>
                <td><span class="badge badge-blue">${escapeHtml(entry.record_type || 'risk')}</span></td>
                <td class="font-mono text-sm">${entry.record_id}</td>
                <td><span class="badge ${actionBadgeClass}">${formatAction(entry.action)}</span></td>
                <td>${escapeHtml(entry.user_name || '-')}</td>
                <td class="text-sm max-w-xs truncate">${escapeHtml(entry.notes || '-')}</td>
            </tr>
        `;
    }).join('');
}

function formatAction(action) {
    const labels = {
        'submit_for_review': 'Submit for Review',
        'return_to_auditor': 'Return to Auditor',
        'sign_off': 'Sign Off',
        'admin_lock': 'Admin Lock',
        'admin_unlock': 'Admin Unlock',
        'admin_unlock_signoff': 'Unlock Sign-off'
    };
    return labels[action] || action;
}

async function unlockRecord(recordType, recordId) {
    const reason = prompt('Enter reason for unlocking:');
    if (!reason) return;

    const returnTo = confirm('Return to In Review? (Cancel for Draft)') ? 'in_review' : 'draft';

    try {
        const res = await fetch(`/api/admin/records/${recordType}/${recordId}/unlock`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason, return_to: returnTo })
        });

        if (res.ok) {
            showToast('Record unlocked', 'success');
            loadRecordsData();
        } else {
            const err = await res.json();
            showToast(err.error || 'Error unlocking record', 'error');
        }
    } catch (err) {
        showToast('Network error', 'error');
    }
}

async function unlockSignoff(recordType, recordId) {
    const reason = prompt('Enter reason for unlocking signed-off record:');
    if (!reason) return;

    const confirmation = prompt('Type "UNLOCK SIGNED OFF" to confirm:');
    if (confirmation !== 'UNLOCK SIGNED OFF') {
        showToast('Confirmation required', 'error');
        return;
    }

    const returnTo = confirm('Return to In Review? (Cancel for Draft)') ? 'in_review' : 'draft';

    try {
        const res = await fetch(`/api/admin/records/${recordType}/${recordId}/unlock-signoff`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason, return_to: returnTo, confirmation })
        });

        if (res.ok) {
            showToast('Signed-off record unlocked', 'success');
            loadRecordsData();
        } else {
            const err = await res.json();
            showToast(err.error || 'Error unlocking record', 'error');
        }
    } catch (err) {
        showToast('Network error', 'error');
    }
}

// Close modals on backdrop click
document.getElementById('userModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeUserModal(); });
document.getElementById('membershipModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeMembershipModal(); });

loadData();
</script>
{% endblock %}
