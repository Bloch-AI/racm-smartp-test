<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartPapers - Internal Audit</title>

    <!-- Google Fonts - Bloch AI Design System -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                        'display': ['Plus Jakarta Sans', 'system-ui', 'sans-serif'],
                        'mono': ['DM Mono', 'monospace'],
                    },
                    colors: {
                        // Bloch AI brand blue
                        primary: {
                            50: '#e6f4fa',
                            100: '#cce9f5',
                            200: '#99d3eb',
                            300: '#66bde1',
                            400: '#33a7d7',
                            500: '#008bd1',
                            600: '#007ab8',
                            700: '#00689e',
                            800: '#005785',
                            900: '#00456b',
                        },
                        // Semantic colors only
                        success: { light: '#dcfce7', DEFAULT: '#22c55e', dark: '#15803d' },
                        warning: { light: '#fef3c7', DEFAULT: '#f59e0b', dark: '#b45309' },
                        danger: { light: '#fee2e2', DEFAULT: '#ef4444', dark: '#b91c1c' },
                        info: { light: '#dbeafe', DEFAULT: '#3b82f6', dark: '#1d4ed8' }
                    }
                }
            }
        }
    </script>

    <!-- Jspreadsheet CSS -->
    <link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jspreadsheet.css" type="text/css" />
    <link rel="stylesheet" href="https://jsuites.net/v5/jsuites.css" type="text/css" />

    <!-- Quill.js CSS -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

    <!-- jKanban CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jkanban@1.3.1/dist/jkanban.min.css">

    <style>
        /* ========================================
           DESIGN SYSTEM - SmartPapers
           Aligned with Bloch AI brand guidelines
           ======================================== */

        * {
            font-family: 'Inter', system-ui, sans-serif;
        }

        h1, h2, h3, .font-display {
            font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
        }

        code, pre, .font-mono {
            font-family: 'DM Mono', monospace;
        }

        :root {
            /* Bloch AI Brand Colors */
            --primary: #008bd1;
            --primary-light: #e6f4fa;
            --primary-dark: #00689e;
            --success: #22c55e;
            --success-light: #dcfce7;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --radius: 8px;
            --radius-lg: 8px;
        }

        /* ========================================
           BUTTON SYSTEM
           ======================================== */

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            height: 36px;
            padding: 0 16px;
            font-size: 13px;
            font-weight: 500;
            border-radius: var(--radius);
            transition: all 0.2s ease;
            cursor: pointer;
            white-space: nowrap;
        }
        .btn svg { width: 16px; height: 16px; }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: scale(1.02);
        }

        .btn-secondary {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #9ca3af;
            transform: scale(1.02);
        }

        .btn-ghost {
            background: transparent;
            color: #6b7280;
            border: none;
        }
        .btn-ghost:hover { background: #f3f4f6; color: #374151; }

        /* ========================================
           STATUS CHIPS / BADGES
           ======================================== */

        .chip {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 500;
            border-radius: 9999px;
            white-space: nowrap;
        }
        .chip-neutral { background: #f3f4f6; color: #4b5563; }
        .chip-success { background: var(--success-light); color: #15803d; }
        .chip-warning { background: var(--warning-light); color: #b45309; }
        .chip-danger { background: var(--danger-light); color: #b91c1c; }
        .chip-info { background: var(--primary-light); color: var(--primary-dark); }

        /* ========================================
           TABLE STYLES - Clean & Professional
           ======================================== */

        .jexcel_content, .jspreadsheet_content {
            font-family: inherit;
        }
        .jexcel tbody td, .jspreadsheet tbody td {
            font-size: 13px;
            white-space: normal !important;
            word-wrap: break-word;
            vertical-align: top;
            padding: 10px 12px;
            border-color: #f1f5f9 !important;
        }
        /* Clean header - light background, not dark */
        .jexcel thead tr:first-child td, .jspreadsheet thead tr:first-child td {
            background: #f8fafc !important;
            color: #475569 !important;
            font-weight: 600;
            font-size: 12px;
            text-transform: none;
            letter-spacing: normal;
            white-space: normal !important;
            word-wrap: break-word;
            vertical-align: middle;
            padding: 12px 12px;
            line-height: 1.4;
            border-bottom: 2px solid #e2e8f0 !important;
        }
        /* Zebra striping */
        .jexcel tbody tr:nth-child(even) td, .jspreadsheet tbody tr:nth-child(even) td {
            background-color: #fafafa;
        }
        .jexcel tbody tr:hover td, .jspreadsheet tbody tr:hover td {
            background-color: #f0f9ff !important;
        }
        .jexcel_container, .jspreadsheet_container {
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05);
            border: 1px solid #e2e8f0;
        }

        /* Filter row styling */
        .jexcel thead tr.jexcel_filter td, .jspreadsheet thead tr.jexcel_filter td {
            background: white !important;
            padding: 8px 8px;
        }
        .jexcel thead tr.jexcel_filter td input,
        .jspreadsheet thead tr.jexcel_filter td input {
            width: 100% !important;
            padding: 6px 10px !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: var(--radius) !important;
            font-size: 12px !important;
            background: #f9fafb !important;
            color: #374151 !important;
            box-sizing: border-box;
        }
        .jexcel thead tr.jexcel_filter td input:focus,
        .jspreadsheet thead tr.jexcel_filter td input:focus {
            border-color: var(--primary) !important;
            outline: none !important;
            box-shadow: 0 0 0 2px rgba(0, 139, 209, 0.15) !important;
            background: white !important;
        }

        /* Ensure both tables use full width */
        #spreadsheet-racm .jexcel_container,
        #spreadsheet-racm .jexcel,
        #spreadsheet-issues .jexcel_container,
        #spreadsheet-issues .jexcel {
            width: 100% !important;
        }

        /* Make spreadsheet container fill available space */
        #spreadsheet {
            width: 100%;
        }
        #spreadsheet-racm,
        #spreadsheet-issues {
            width: 100%;
        }

        /* ========================================
           DRAWER / PANEL STYLES
           ======================================== */

        .drawer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: var(--primary);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .drawer-header-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(255,255,255,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .drawer-header-icon svg { width: 20px; height: 20px; color: white; }
        .drawer-header-title { font-size: 15px; font-weight: 600; color: white; }
        .drawer-header-subtitle { font-size: 12px; color: rgba(255,255,255,0.7); }
        .drawer-close {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.7);
            transition: all 0.15s;
        }
        .drawer-close:hover { background: rgba(255,255,255,0.1); color: white; }

        /* ========================================
           MODAL STYLES
           ======================================== */

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        .modal-title { font-size: 16px; font-weight: 600; color: #1e293b; }
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            transition: all 0.15s;
        }
        .modal-close:hover { background: #f1f5f9; color: #4b5563; }

        /* ========================================
           FORM STYLES
           ======================================== */

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }
        .form-input {
            width: 100%;
            height: 38px;
            padding: 0 12px;
            font-size: 14px;
            border: 1px solid #d1d5db;
            border-radius: var(--radius);
            transition: all 0.15s;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 139, 209, 0.15);
        }
        .form-hint {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        /* ========================================
           INLINE ACTIONS
           ======================================== */

        .action-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: var(--primary);
            text-decoration: none;
            transition: color 0.15s;
        }
        .action-link:hover { color: var(--primary-dark); }
        .action-link svg { width: 14px; height: 14px; }

        /* ========================================
           QUILL EDITOR & DOCUMENT MODAL
           Clean implementation for scroll + resize
           ======================================== */

        /* Modal container - simple fixed dimensions */
        .doc-modal-container {
            position: relative;
            background: white;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 90vw;
            max-width: 1000px;
            height: 85vh;
            max-height: 900px;
            display: flex;
            flex-direction: column;
            /* No overflow:hidden - content area handles its own overflow */
        }

        .doc-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            flex: 0 0 auto;
        }

        .doc-modal-header-title {
            font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: #0f172a;
        }

        .doc-modal-header-subtitle {
            font-size: 13px;
            color: #64748b;
            margin-top: 2px;
            font-family: 'DM Mono', monospace;
        }

        .doc-modal-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .doc-modal-btn-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            color: #64748b;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .doc-modal-btn-icon:hover {
            background: #f1f5f9;
            color: #334155;
        }
        .doc-modal-btn-icon svg {
            width: 20px;
            height: 20px;
        }

        .doc-modal-tip {
            padding: 12px 24px;
            background: var(--primary-light);
            border-bottom: 1px solid #cce9f5;
            font-size: 13px;
            color: var(--primary-dark);
            flex: 0 0 auto;
        }

        /* Content area - this is where scroll happens */
        .doc-modal-content {
            flex: 1 1 auto;
            min-height: 0; /* Critical for flex scroll */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .doc-modal-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            flex: 0 0 auto;
        }

        /* Quill toolbar - fixed at top of content */
        .doc-modal-content .ql-toolbar.ql-snow {
            flex: 0 0 auto;
            border: none !important;
            border-bottom: 1px solid #e2e8f0 !important;
            background: #fafafa !important;
            padding: 12px 16px !important;
        }

        /* Quill container - takes remaining space, enables scroll */
        .doc-modal-content .ql-container.ql-snow {
            flex: 1 1 auto;
            min-height: 0; /* Critical for flex scroll */
            border: none !important;
            font-size: 14px !important;
            font-family: 'Inter', system-ui, sans-serif !important;
            overflow: hidden !important;
        }

        /* Quill editor - the actual scrollable area */
        .doc-modal-content .ql-editor {
            height: 100% !important;
            overflow-y: auto !important;
            padding: 24px !important;
            line-height: 1.7 !important;
        }
        .doc-modal-content .ql-editor:focus {
            outline: none;
        }
        .doc-modal-content .ql-editor p {
            margin-bottom: 12px;
        }
        .doc-modal-content .ql-editor h1,
        .doc-modal-content .ql-editor h2,
        .doc-modal-content .ql-editor h3 {
            font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
            font-weight: 600;
            margin-top: 24px;
            margin-bottom: 12px;
        }

        /* Resize handle - triangle in corner */
        .doc-modal-resize {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 24px;
            height: 24px;
            cursor: nwse-resize;
            z-index: 9999;
            background: linear-gradient(135deg, transparent 50%, #cbd5e1 50%);
            border-radius: 0 0 12px 0;
        }
        .doc-modal-resize:hover {
            background: linear-gradient(135deg, transparent 50%, #008bd1 50%);
        }

        /* Fullscreen/maximized state */
        .doc-modal-container.maximized {
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
            border-radius: 0;
        }
        .doc-modal-container.maximized .doc-modal-resize {
            display: none;
        }

        /* ========================================
           TOAST NOTIFICATIONS
           ======================================== */

        .toast {
            animation: slideIn 0.3s ease-out;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* ========================================
           EMPTY STATES
           ======================================== */

        .empty-state {
            text-align: center;
            padding: 32px 16px;
            color: #6b7280;
        }
        .empty-state-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            color: #d1d5db;
        }
        .empty-state-title {
            font-size: 14px;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 4px;
        }
        .empty-state-text {
            font-size: 13px;
            color: #9ca3af;
        }

        /* ========================================
           KANBAN BOARD STYLES
           ======================================== */

        .kanban-container {
            display: flex;
            gap: 16px;
            padding: 8px 0;
        }
        .kanban-board {
            background: white;
            border-radius: 8px;
            min-width: 280px;
            max-width: 280px;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05);
            border: 1px solid #e2e8f0;
        }
        .kanban-board header {
            padding: 14px 16px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 8px 8px 0 0;
        }
        .kanban-board header .kanban-title-board {
            font-weight: 600;
            font-size: 13px;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        .kanban-drag {
            min-height: 100px;
            padding: 12px;
            background: #fafafa;
        }
        .kanban-item {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            border: 1px solid #e5e7eb;
            cursor: grab;
            transition: all 0.15s ease;
        }
        .kanban-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #d1d5db;
        }
        .kanban-item[data-priority="high"] {
            border-left: 3px solid #ef4444;
        }
        .kanban-item[data-priority="medium"] {
            border-left: 3px solid #f59e0b;
        }
        .kanban-item[data-priority="low"] {
            border-left: 3px solid #22c55e;
        }

        /* ========================================
           TAB STYLES - Matching Audit Plan
           ======================================== */

        .tab-btn {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.15s ease;
            cursor: pointer;
            background: transparent;
            border-top: none;
            border-left: none;
            border-right: none;
        }
        .tab-btn:hover { color: #374151; }
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
    </style>
</head>
<body class="h-full">
    <div class="min-h-full">
        <!-- Navigation -->
        <nav class="bg-white border-b border-slate-200">
            <div class="flex h-16 items-center justify-between px-4 sm:px-6">
                <!-- Left: Logo + Nav Links -->
                <div class="flex items-center">
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <img src="/static/logo.png" alt="SmartPapers Logo" class="h-8 w-auto">
                        <div class="flex flex-col">
                            <span class="text-xl font-bold text-slate-900 leading-tight font-display">SmartPapers</span>
                            <span class="text-xs text-slate-400 -mt-0.5">Internal Audit</span>
                        </div>
                    </div>
                    <div class="hidden sm:flex sm:items-center sm:ml-8 sm:space-x-1">
                        <a href="/audit-plan" class="text-slate-500 hover:bg-slate-100 hover:text-slate-700 rounded-md px-3 py-2 text-sm font-medium transition-colors">
                            Audit Plan
                        </a>
                        <a href="/" class="bg-primary-50 text-primary-700 rounded-md px-3 py-2 text-sm font-medium">
                            Audit Workpapers
                        </a>
                    </div>
                </div>
                <!-- Right side -->
                <div class="flex items-center gap-4">
                    <div class="hidden sm:flex sm:items-center sm:space-x-1">
                        <a href="/felix" class="flex items-center gap-1.5 text-slate-500 hover:bg-slate-100 hover:text-slate-700 rounded-md px-3 py-2 text-sm font-medium transition-colors">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z"/>
                            </svg>
                            Felix AI
                        </a>
                        <a href="/library" class="flex items-center gap-1.5 text-slate-500 hover:bg-slate-100 hover:text-slate-700 rounded-md px-3 py-2 text-sm font-medium transition-colors">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                            </svg>
                            Library
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main content -->
        <main class="py-6">
            <div class="mx-auto px-4 sm:px-6">
                <!-- Header -->
                <div class="mb-6">
                    <h1 class="text-xl font-semibold text-slate-900 font-display">{{ audit_name or 'Untitled Audit' }}</h1>
                    <p id="page-subtitle" class="text-sm text-slate-500">Risk and control matrix</p>
                </div>

                <!-- Tab Bar -->
                <div class="flex items-center justify-between border-b border-slate-200 mb-6">
                    <div class="flex">
                        <button id="tab-racm" class="tab-btn active" onclick="switchTab('racm')">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Risk & Control Matrix
                            </span>
                        </button>
                        <button id="tab-issues" class="tab-btn" onclick="switchTab('issues')">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                Issue Log
                            </span>
                        </button>
                        <button id="tab-plan" class="tab-btn" onclick="switchTab('plan')">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" />
                                </svg>
                                Audit Plan
                            </span>
                        </button>
                    </div>
                    <!-- Right side: Ask Felix + Import/Export + Add Row + Save + Search -->
                    <div class="flex items-center gap-2 pb-2">
                        <button onclick="toggleChat()" class="btn btn-ghost">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z"/>
                            </svg>
                            Ask Felix
                        </button>
                        <div class="relative" id="importExportDropdown">
                            <button onclick="toggleImportExport()" class="btn btn-ghost">
                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                </svg>
                                Import / Export
                                <svg class="w-4 h-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div id="importExportMenu" class="hidden absolute right-0 mt-1 w-44 bg-white rounded-lg shadow-lg border border-slate-200 py-1 z-10">
                                <button onclick="exportExcel(); toggleImportExport();" class="w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    Export to Excel
                                </button>
                                <label class="w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2 cursor-pointer">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                    </svg>
                                    Import from Excel
                                    <input type="file" id="fileInput" onchange="importExcel(event); toggleImportExport();" accept=".xlsx,.xls" class="hidden">
                                </label>
                            </div>
                        </div>
                        <div id="table-action-buttons" class="flex items-center gap-2">
                            <button onclick="addRow()" class="btn btn-ghost">
                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Add Row
                            </button>
                            <button onclick="saveData()" class="btn btn-ghost">
                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                                </svg>
                                Save
                            </button>
                        </div>
                        <div id="table-search-container" class="relative">
                            <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <input type="text" id="table-search" placeholder="Search..." oninput="searchTable(this.value)" class="h-9 pl-9 pr-3 text-sm border border-slate-200 rounded-lg bg-white focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500 w-48">
                        </div>
                    </div>
                </div>

                <!-- Spreadsheet Container -->
                <div id="spreadsheet" class="bg-white rounded-lg shadow-sm border border-slate-200">
                    <div id="spreadsheet-racm"></div>
                    <div id="spreadsheet-issues" style="display: none;"></div>
                </div>
                <div id="kanban-container" style="display: none;" class="p-4">
                    <div id="kanban-board" class="overflow-x-auto pb-4"></div>
                </div>

                <!-- Toast notifications -->
                <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 max-w-sm"></div>
            </div>
        </main>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md mx-4 overflow-hidden">
            <div class="modal-header">
                <h3 id="taskModalTitle" class="modal-title">Add Task</h3>
                <button onclick="closeTaskModal()" class="modal-close">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <input type="hidden" id="taskId">
                <input type="hidden" id="taskRow">

                <div>
                    <label class="form-label">Title</label>
                    <input type="text" id="taskTitle" placeholder="Task title..." class="form-input">
                </div>

                <div>
                    <label class="form-label">Description</label>
                    <textarea id="taskDescription" placeholder="What needs to be done?" rows="3" class="form-input" style="height: auto; padding: 10px 12px;"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Priority</label>
                        <select id="taskPriority" class="form-input">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Due Date</label>
                        <input type="date" id="taskDueDate" class="form-input">
                        <p class="form-hint">YYYY-MM-DD format</p>
                    </div>
                </div>

                <div>
                    <label class="form-label">Assignee</label>
                    <input type="text" id="taskAssignee" placeholder="Who is responsible?" class="form-input">
                    <p class="form-hint">Team member or role</p>
                </div>

                <div id="taskStatus" class="hidden rounded-md bg-primary-50 p-3 border border-primary-200">
                    <p class="text-sm text-primary-700">Status: <span id="taskStatusText" class="font-medium"></span></p>
                </div>
            </div>
            <div class="px-5 py-4 bg-slate-50 border-t border-slate-200 flex items-center justify-end gap-2">
                <a id="viewOnBoardLink" href="/kanban" target="_blank" class="hidden">
                    <button type="button" class="btn btn-secondary">View on Board</button>
                </a>
                <button onclick="closeTaskModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="saveTask()" class="btn btn-primary">Save Task</button>
            </div>
        </div>
    </div>

    <!-- Test Document Editor Modal -->
    <div id="testDocModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 hidden items-center justify-center">
        <div class="doc-modal-container">
            <div class="doc-modal-header">
                <div>
                    <p id="testDocModalAuditName" class="text-xs text-slate-400 font-medium uppercase tracking-wide mb-1">{{ audit_name or 'Untitled Audit' }}</p>
                    <h3 id="testDocModalTitle" class="doc-modal-header-title">Design Effectiveness Testing</h3>
                    <p id="testDocModalSubtitle" class="doc-modal-header-subtitle">Risk: R001</p>
                </div>
                <div class="doc-modal-header-actions">
                    <button onclick="toggleTestDocModalMaximize()" class="doc-modal-btn-icon" title="Maximize">
                        <svg id="testDocMaximizeIcon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                        </svg>
                        <svg id="testDocMinimizeIcon" class="hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25" />
                        </svg>
                    </button>
                    <button onclick="closeTestDocModal()" class="doc-modal-btn-icon" title="Close">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="doc-modal-tip">
                <span class="font-medium">Tip:</span> Include objective, test steps, sample details, results, and conclusion.
            </div>
            <div class="doc-modal-content">
                <input type="hidden" id="testDocRiskCode">
                <input type="hidden" id="testDocType">
                <div id="testDocEditor"></div>
            </div>
            <div class="doc-modal-footer">
                <button onclick="closeTestDocModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="saveTestDocument()" class="btn btn-primary">Save Document</button>
            </div>
            <!-- Resize handle -->
            <div class="doc-modal-resize" id="docModalResize"></div>
        </div>
    </div>

    <!-- Evidence Panel (slides in from left) -->
    <div id="evidencePanel" class="fixed inset-y-0 left-0 w-full sm:w-[480px] max-w-full bg-white shadow-2xl z-50 transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
        <!-- Header - uses unified drawer style -->
        <div class="drawer-header flex-shrink-0">
            <div class="flex items-center gap-3">
                <div class="drawer-header-icon">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                </div>
                <div>
                    <h2 id="evidencePanelTitle" class="drawer-header-title">Evidence & Working Papers</h2>
                    <p id="evidencePanelSubtitle" class="drawer-header-subtitle">Risk: R001</p>
                </div>
            </div>
            <button onclick="closeEvidencePanel()" class="drawer-close">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Hidden inputs -->
        <input type="hidden" id="evidenceItemId">
        <input type="hidden" id="evidenceItemType">

        <!-- Category Tabs -->
        <div id="evidenceTabs" class="border-b border-slate-200 bg-white flex-shrink-0">
            <nav class="flex px-4" aria-label="Evidence Categories">
                <button id="tab-planning" onclick="switchEvidenceTab('planning')" class="evidence-tab px-4 py-3 text-sm font-medium border-b-2 border-primary-500 text-primary-700">
                    Planning
                </button>
                <button id="tab-de" onclick="switchEvidenceTab('de')" class="evidence-tab px-4 py-3 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700">
                    DE Testing
                </button>
                <button id="tab-oe" onclick="switchEvidenceTab('oe')" class="evidence-tab px-4 py-3 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700">
                    OE Testing
                </button>
                <button id="tab-issue" onclick="switchEvidenceTab('issue')" class="evidence-tab hidden px-4 py-3 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700">
                    Issue
                </button>
            </nav>
        </div>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto p-4 bg-slate-50">
            <!-- Upload Section -->
            <div class="mb-4">
                <div class="border-2 border-dashed border-slate-300 rounded-lg p-5 text-center hover:border-primary-400 hover:bg-primary-50/30 transition-colors bg-white">
                    <input type="file" id="evidenceFileInput" multiple class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.msg,.eml,.txt,.csv,.png,.jpg,.jpeg,.gif,.zip">
                    <label for="evidenceFileInput" class="cursor-pointer">
                        <svg class="mx-auto h-10 w-10 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <p class="mt-2 text-sm font-medium text-slate-700">Click to upload evidence</p>
                        <p class="text-xs text-slate-500 mt-1">PDF, Word, Excel, Email, Images (max 50MB)</p>
                    </label>
                </div>
            </div>

            <!-- Files List -->
            <div>
                <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3" id="evidenceListTitle">Planning Documents</h4>
                <div id="evidenceFilesList" class="space-y-2">
                    <!-- Empty state -->
                    <div class="empty-state bg-white rounded-lg border border-slate-200">
                        <svg class="empty-state-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="empty-state-title">No evidence uploaded yet</p>
                        <p class="empty-state-text">Upload documents to support your audit work</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Evidence Panel Backdrop -->
    <div id="evidenceBackdrop" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 hidden" onclick="closeEvidencePanel()"></div>

    <!-- Chat Panel -->
    <div id="chatPanel" class="fixed inset-y-0 right-0 w-full sm:w-[420px] max-w-full bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
        <!-- Chat Header - uses unified drawer style -->
        <div class="drawer-header flex-shrink-0">
            <div class="flex items-center gap-3">
                <div class="drawer-header-icon">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                </div>
                <div>
                    <h2 class="drawer-header-title">AI Audit Assistant</h2>
                    <p class="drawer-header-subtitle">Powered by Felix</p>
                </div>
            </div>
            <div class="flex items-center gap-1">
                <button onclick="clearChat()" class="drawer-close" title="Clear chat">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
                <button onclick="toggleChat()" class="drawer-close">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Chat Messages -->
        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
            <div class="flex gap-3">
                <div class="flex-shrink-0 h-8 w-8 rounded-full bg-primary-100 flex items-center justify-center">
                    <svg class="h-4 w-4 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                </div>
                <div class="flex-1 bg-white rounded-lg p-4 shadow-sm border border-slate-200">
                    <p class="text-sm text-slate-700 mb-3">Hi! I'm your AI audit assistant. What would you like to do?</p>
                    <!-- Quick action chips -->
                    <div class="flex flex-wrap gap-2">
                        <button onclick="insertChatMessage('Add a new risk to the RACM')" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-full transition-colors">
                            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                            Add risk
                        </button>
                        <button onclick="insertChatMessage('Create a flowchart for the control walkthrough')" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-full transition-colors">
                            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5z" /></svg>
                            Create flowchart
                        </button>
                        <button onclick="insertChatMessage('Add a task to the audit plan')" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-full transition-colors">
                            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                            Add task
                        </button>
                        <button onclick="insertChatMessage('Summarize the current audit status')" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-full transition-colors">
                            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                            Summarize
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div id="typingIndicator" class="hidden px-4 py-2 bg-slate-50">
            <div class="flex items-center gap-2 text-sm text-slate-500">
                <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
                Felix is thinking...
            </div>
        </div>

        <!-- Chat Input -->
        <div class="p-4 border-t border-slate-200 bg-white">
            <div class="flex gap-2">
                <input type="text" id="chatInput" placeholder="Ask about your audit..." onkeypress="handleChatKeypress(event)" class="flex-1 rounded-lg border-slate-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm px-4 py-2">
                <button id="chatSend" onclick="sendMessage()" class="btn btn-primary">
                    Send
                </button>
            </div>
            <p class="text-xs text-slate-400 mt-2">Press Enter to send</p>
        </div>
    </div>

    <!-- Kanban Edit Card Modal -->
    <div id="kanbanEditModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 hidden items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
            <div class="modal-header">
                <h3 id="kanbanModalTitle" class="text-base font-semibold text-slate-900">Edit Task</h3>
                <button onclick="closeKanbanModal()" class="modal-close" aria-label="Close">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="kanbanEditItemId">
                <input type="hidden" id="kanbanEditColumnId">

                <div>
                    <label class="form-label">Title</label>
                    <input type="text" id="kanbanEditTitle" placeholder="Task title..." class="form-input">
                </div>

                <div>
                    <label class="form-label">Description</label>
                    <textarea id="kanbanEditDescription" placeholder="Task description..." rows="3" class="form-input" style="height: auto; padding: 10px 12px;"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Priority</label>
                        <select id="kanbanEditPriority" class="form-input">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Due Date</label>
                        <input type="date" id="kanbanEditDueDate" class="form-input">
                    </div>
                </div>

                <div>
                    <label class="form-label">Assignee</label>
                    <input type="text" id="kanbanEditAssignee" placeholder="Who is responsible?" class="form-input">
                </div>
            </div>
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex items-center justify-between">
                <button id="kanbanDeleteBtn" onclick="deleteKanbanCard()" class="btn" style="background: #ef4444; color: white;">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                </button>
                <div class="flex gap-2">
                    <button onclick="closeKanbanModal()" class="btn btn-secondary">Cancel</button>
                    <button onclick="saveKanbanCard()" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Backdrop -->
    <div id="chatBackdrop" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 hidden" onclick="toggleChat()"></div>

    <!-- Jspreadsheet JS -->
    <script src="https://bossanova.uk/jspreadsheet/v4/jspreadsheet.js"></script>
    <script src="https://jsuites.net/v5/jsuites.js"></script>

    <!-- jKanban JS -->
    <script src="https://cdn.jsdelivr.net/npm/jkanban@1.3.1/dist/jkanban.min.js"></script>

    <!-- SheetJS for Excel import/export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Quill.js for rich text editing -->
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

    <!-- Shared JavaScript utilities -->
    <script src="/static/js/utils.js"></script>

    <script>
        let table;  // RACM spreadsheet
        let issueTable;  // Issue Log spreadsheet
        let currentTab = 'racm';  // 'racm', 'issues', or 'plan'

        // Kanban board variables
        let kanban = null;
        let kanbanData = null;
        let kanbanInitialized = false;
        let kanbanItemIdCounter = 100;
        const kanbanBoardId = 'default';

        // Get current active table
        function getActiveTable() {
            return currentTab === 'racm' ? table : issueTable;
        }

        // Check if a row has any populated cells
        function isRowPopulated(row) {
            return row.some(cell => cell !== null && cell !== undefined && cell !== '' && cell !== false);
        }

        // Filter data to only populated rows, ensuring at least one row
        function trimEmptyRows(data, emptyRowTemplate) {
            const filtered = data.filter(isRowPopulated);
            return filtered.length > 0 ? filtered : [emptyRowTemplate];
        }

        // Toggle import/export dropdown
        function toggleImportExport() {
            const menu = document.getElementById('importExportMenu');
            menu.classList.toggle('hidden');
        }
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('importExportDropdown');
            const menu = document.getElementById('importExportMenu');
            if (dropdown && menu && !dropdown.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        // Insert message into chat input (for quick action chips)
        function insertChatMessage(message) {
            const input = document.getElementById('chatInput');
            input.value = message;
            input.focus();
        }

        // Switch between tabs
        function switchTab(tab) {
            currentTab = tab;

            // Update page subtitle
            const subtitles = {
                'racm': 'Risk and control matrix',
                'issues': 'Issue log',
                'plan': 'Audit planning board'
            };
            document.getElementById('page-subtitle').textContent = subtitles[tab] || '';

            // Update tab button styles
            document.getElementById('tab-racm').className = tab === 'racm' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('tab-issues').className = tab === 'issues' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('tab-plan').className = tab === 'plan' ? 'tab-btn active' : 'tab-btn';

            // Clear search when switching tabs
            const searchInput = document.getElementById('table-search');
            if (searchInput) {
                searchInput.value = '';
                if (table) table.search('');
                if (issueTable) issueTable.search('');
            }

            // Show/hide import/export and action buttons on spreadsheet tabs only (search stays visible)
            const importExportDropdown = document.getElementById('importExportDropdown');
            const actionButtons = document.getElementById('table-action-buttons');
            const showTableTools = (tab === 'racm' || tab === 'issues');
            if (importExportDropdown) importExportDropdown.style.display = showTableTools ? 'block' : 'none';
            if (actionButtons) actionButtons.style.display = showTableTools ? 'flex' : 'none';

            // Show/hide content areas
            document.getElementById('spreadsheet-racm').style.display = tab === 'racm' ? 'block' : 'none';
            document.getElementById('spreadsheet-issues').style.display = tab === 'issues' ? 'block' : 'none';
            document.getElementById('kanban-container').style.display = tab === 'plan' ? 'block' : 'none';

            // Initialize kanban board on first view
            if (tab === 'plan' && !kanbanInitialized) {
                initKanban();
            }

            // Refresh the visible table to fix rendering issues
            if (tab === 'issues' && issueTable) {
                // Force resize and re-render
                setTimeout(async () => {
                    const container = document.getElementById('spreadsheet-issues');
                    const wrapper = document.getElementById('spreadsheet');
                    const parentWidth = wrapper.offsetWidth - 2;
                    const tableEl = container.querySelector('.jexcel_container');
                    if (tableEl) {
                        tableEl.style.width = parentWidth + 'px';
                    }
                    // Also resize the jexcel table element itself
                    const jexcelTable = container.querySelector('.jexcel');
                    if (jexcelTable) {
                        jexcelTable.style.width = '100%';
                    }
                    // Re-fetch and set data to force complete re-render
                    const response = await fetch('/api/data');
                    const allData = await response.json();
                    const issuesData = trimEmptyRows(allData.issues || [], ['', '', '', '', 'Medium', 'Open', '', '', '']);
                    issueTable.setData(issuesData);
                    // Load issue documentation status and attachment counts
                    await loadIssueDocStatus();
                    await loadAttachmentCounts();
                }, 50);
            } else if (tab === 'racm' && table) {
                setTimeout(() => {
                    table.refresh();
                    // Also refresh test doc status to ensure links show
                    loadTestDocStatus();
                }, 50);
            }
        }

        // ==================== KANBAN BOARD FUNCTIONS ====================

        async function initKanban() {
            const response = await fetch(`/api/kanban/${kanbanBoardId}`);
            const savedData = await response.json();

            // Define the required columns
            const requiredColumns = [
                { id: 'not_started', title: 'Not Started' },
                { id: 'design_effectiveness', title: 'Design Effectiveness' },
                { id: 'operational_effectiveness', title: 'Operational Effectiveness' },
                { id: 'complete', title: 'Complete' }
            ];

            // Always use the required columns, but preserve any existing items
            kanbanData = {
                name: 'Audit Plan',
                columns: requiredColumns.map(reqCol => {
                    // Try to find existing column with same id or migrate from old columns
                    let existingItems = [];
                    if (savedData && savedData.columns) {
                        const existingCol = savedData.columns.find(c => c.id === reqCol.id);
                        if (existingCol) {
                            existingItems = existingCol.items || [];
                        }
                    }
                    return { ...reqCol, items: existingItems };
                })
            };

            renderKanbanBoard();
            kanbanInitialized = true;
        }

        function renderKanbanBoard() {
            document.getElementById('kanban-board').innerHTML = '';

            const boards = kanbanData.columns.map(col => ({
                id: col.id,
                title: `${col.title} <span class="ml-2 inline-flex items-center rounded-full bg-slate-200 px-2 py-0.5 text-xs font-medium text-slate-700">${col.items.length}</span>`,
                item: col.items.map(item => ({
                    id: item.id,
                    title: buildKanbanItemHTML(item),
                    priority: item.priority || 'low'
                }))
            }));

            kanban = new jKanban({
                element: '#kanban-board',
                boards: boards,
                dragItems: true,
                dragBoards: false,
                itemHandleOptions: { enabled: false },
                click: function(el) {
                    const itemId = el.getAttribute('data-eid');
                    openKanbanEditModal(itemId);
                },
                dropEl: function(el, target, source, sibling) {
                    updateKanbanData();
                    saveKanbanBoard();
                }
            });

            // Add "Add task" buttons
            document.querySelectorAll('.kanban-board').forEach(board => {
                const boardId = board.getAttribute('data-id');
                const addBtn = document.createElement('button');
                addBtn.className = 'w-full mt-2 px-3 py-2 text-sm text-slate-500 hover:text-slate-700 hover:bg-slate-50 rounded-lg transition-colors flex items-center justify-center gap-2';
                addBtn.innerHTML = '<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> Add task';
                addBtn.onclick = () => openKanbanAddModal(boardId);
                board.querySelector('.kanban-drag').after(addBtn);
            });
        }

        function buildKanbanItemHTML(item) {
            const priorityColors = {
                high: 'bg-red-100 text-red-700',
                medium: 'bg-amber-100 text-amber-700',
                low: 'bg-emerald-100 text-emerald-700'
            };
            const priorityColor = priorityColors[item.priority] || priorityColors.low;

            let html = `<div class="font-medium text-sm text-slate-900">${escapeHtmlKanban(item.title)}</div>`;
            if (item.description) {
                html += `<div class="mt-1 text-xs text-slate-500 line-clamp-2">${escapeHtmlKanban(item.description)}</div>`;
            }
            html += `<div class="mt-2 flex items-center gap-2 flex-wrap">`;
            html += `<span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${priorityColor}">${item.priority || 'low'}</span>`;
            if (item.assignee) html += `<span class="text-xs text-slate-500 flex items-center gap-1"><svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>${escapeHtmlKanban(item.assignee)}</span>`;
            if (item.dueDate) html += `<span class="text-xs text-slate-500 flex items-center gap-1"><svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>${item.dueDate}</span>`;
            html += `</div>`;
            return html;
        }

        function escapeHtmlKanban(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateKanbanData() {
            kanbanData.columns = kanbanData.columns.map(col => {
                const boardEl = document.querySelector(`.kanban-board[data-id="${col.id}"]`);
                if (boardEl) {
                    const items = [];
                    boardEl.querySelectorAll('.kanban-item').forEach(itemEl => {
                        const itemId = itemEl.getAttribute('data-eid');
                        let originalItem = null;
                        kanbanData.columns.forEach(c => {
                            const found = c.items.find(i => i.id === itemId);
                            if (found) originalItem = found;
                        });
                        if (originalItem) items.push(originalItem);
                    });
                    col.items = items;
                }
                return col;
            });
        }

        function openKanbanAddModal(columnId) {
            document.getElementById('kanbanModalTitle').textContent = 'Add Task';
            document.getElementById('kanbanEditItemId').value = '';
            document.getElementById('kanbanEditColumnId').value = columnId;
            document.getElementById('kanbanEditTitle').value = '';
            document.getElementById('kanbanEditDescription').value = '';
            document.getElementById('kanbanEditPriority').value = 'medium';
            document.getElementById('kanbanEditAssignee').value = '';
            document.getElementById('kanbanEditDueDate').value = '';
            document.getElementById('kanbanDeleteBtn').style.display = 'none';
            document.getElementById('kanbanEditModal').classList.remove('hidden');
            document.getElementById('kanbanEditModal').classList.add('flex');
        }

        function openKanbanEditModal(itemId) {
            let item = null;
            let columnId = null;
            kanbanData.columns.forEach(col => {
                const found = col.items.find(i => i.id === itemId);
                if (found) { item = found; columnId = col.id; }
            });
            if (!item) return;

            document.getElementById('kanbanModalTitle').textContent = 'Edit Task';
            document.getElementById('kanbanEditItemId').value = itemId;
            document.getElementById('kanbanEditColumnId').value = columnId;
            document.getElementById('kanbanEditTitle').value = item.title || '';
            document.getElementById('kanbanEditDescription').value = item.description || '';
            document.getElementById('kanbanEditPriority').value = item.priority || 'medium';
            document.getElementById('kanbanEditAssignee').value = item.assignee || '';
            document.getElementById('kanbanEditDueDate').value = item.dueDate || '';
            document.getElementById('kanbanDeleteBtn').style.display = 'block';
            document.getElementById('kanbanEditModal').classList.remove('hidden');
            document.getElementById('kanbanEditModal').classList.add('flex');
        }

        function closeKanbanModal() {
            document.getElementById('kanbanEditModal').classList.add('hidden');
            document.getElementById('kanbanEditModal').classList.remove('flex');
        }

        function saveKanbanCard() {
            const itemId = document.getElementById('kanbanEditItemId').value;
            const columnId = document.getElementById('kanbanEditColumnId').value;
            const title = document.getElementById('kanbanEditTitle').value.trim();
            const description = document.getElementById('kanbanEditDescription').value.trim();
            const priority = document.getElementById('kanbanEditPriority').value;
            const assignee = document.getElementById('kanbanEditAssignee').value.trim();
            const dueDate = document.getElementById('kanbanEditDueDate').value;

            if (!title) {
                showToast('Please enter a title', 'warning');
                return;
            }

            if (itemId) {
                kanbanData.columns.forEach(col => {
                    const item = col.items.find(i => i.id === itemId);
                    if (item) {
                        item.title = title;
                        item.description = description;
                        item.priority = priority;
                        item.assignee = assignee;
                        item.dueDate = dueDate;
                    }
                });
            } else {
                const newItem = {
                    id: 'item-' + (++kanbanItemIdCounter),
                    title, description, priority, assignee, dueDate
                };
                const col = kanbanData.columns.find(c => c.id === columnId);
                if (col) col.items.push(newItem);
            }

            closeKanbanModal();
            renderKanbanBoard();
            saveKanbanBoard();
        }

        function deleteKanbanCard() {
            const itemId = document.getElementById('kanbanEditItemId').value;
            if (!itemId) return;
            if (confirm('Delete this task?')) {
                kanbanData.columns.forEach(col => {
                    col.items = col.items.filter(i => i.id !== itemId);
                });
                closeKanbanModal();
                renderKanbanBoard();
                saveKanbanBoard();
            }
        }

        function addKanbanColumn() {
            const title = prompt('Enter column title:');
            if (title && title.trim()) {
                const id = title.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now();
                kanbanData.columns.push({ id, title: title.trim(), items: [] });
                renderKanbanBoard();
                saveKanbanBoard();
            }
        }

        async function saveKanbanBoard() {
            updateKanbanData();
            await fetch(`/api/kanban/${kanbanBoardId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(kanbanData)
            });
            showToast('Board saved!', 'success');
        }

        // ==================== END KANBAN BOARD FUNCTIONS ====================

        // Initialize both spreadsheets
        async function init() {
            const response = await fetch('/api/data');
            const allData = await response.json();

            let racmData = allData.racm || [];
            let issuesData = allData.issues || [];

            // Skip header row if first row contains header text
            if (racmData.length > 0 && racmData[0][0] && typeof racmData[0][0] === 'string' &&
                racmData[0][0].toUpperCase().includes('RISK')) {
                racmData = racmData.slice(1);
            }

            // Filter out empty rows, ensure at least one row
            const emptyRacmRow = ['', '', '', '', '', '', '', '', '', false, '', false, false, '', '', ''];
            const emptyIssueRow = ['', '', '', '', 'Medium', 'Open', '', '', ''];
            racmData = trimEmptyRows(racmData, emptyRacmRow);
            issuesData = trimEmptyRows(issuesData, emptyIssueRow);

            const racmContainer = document.getElementById('spreadsheet-racm');
            const issuesContainer = document.getElementById('spreadsheet-issues');
            const containerWidth = racmContainer.parentElement.offsetWidth - 2;

            // Calculate proportional column widths to fill screen
            // RACM has 16 columns with relative proportions
            const racmProportions = [0.5, 1.2, 0.6, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.6, 0.8, 0.6, 0.5, 0.8, 0.6, 0.7];
            const racmTotalProp = racmProportions.reduce((a, b) => a + b, 0);
            const racmBaseUnit = (containerWidth - 50) / racmTotalProp; // 50px for row numbers
            const racmColWidths = racmProportions.map(p => Math.floor(racmBaseUnit * p));

            // Show issues container temporarily for proper initialization
            issuesContainer.style.display = 'block';

            // Create RACM spreadsheet
            table = jspreadsheet(racmContainer, {
                data: racmData,
                columns: [
                    { type: 'text', width: racmColWidths[0], title: 'Risk ID' },
                    { type: 'text', width: racmColWidths[1], title: 'Risk', wordWrap: true },
                    { type: 'text', width: racmColWidths[2], title: 'Control ID' },
                    { type: 'text', width: racmColWidths[3], title: 'Control Owner' },
                    { type: 'text', width: racmColWidths[4], title: 'DE Testing', wordWrap: true },
                    { type: 'text', width: racmColWidths[5], title: 'DE Conclusion', wordWrap: true },
                    { type: 'text', width: racmColWidths[6], title: 'OE Testing', wordWrap: true },
                    { type: 'text', width: racmColWidths[7], title: 'OE Conclusion', wordWrap: true },
                    { type: 'dropdown', width: racmColWidths[8], title: 'Status', source: ['Effective', 'Not Effective', 'Not Complete'] },
                    { type: 'checkbox', width: racmColWidths[9], title: 'Ready for Review?' },
                    { type: 'text', width: racmColWidths[10], title: 'Reviewer' },
                    { type: 'checkbox', width: racmColWidths[11], title: 'Raise Issue?' },
                    { type: 'checkbox', width: racmColWidths[12], title: 'Closed' },
                    { type: 'text', width: racmColWidths[13], title: 'Flowchart' },
                    { type: 'text', width: racmColWidths[14], title: 'Task' },
                    { type: 'text', width: racmColWidths[15], title: 'Evidence', readOnly: true },
                ],
                wordWrap: true,
                defaultRowHeight: 40,
                columnResize: true,
                rowResize: true,
                columnDrag: true,
                minDimensions: [16, 1],
                tableOverflow: true,
                tableWidth: containerWidth + 'px',
                tableHeight: 'auto',
                filters: true,
                search: false,
                updateTable: updateRACMTable,
                onchange: onRACMChange,
                contextMenu: function(obj, x, y, e) {
                    let items = [];
                    items.push({ title: 'Merge cells', onclick: function() { mergeSelected(); } });
                    items.push({ title: 'Unmerge cells', onclick: function() { unmergeSelected(); } });
                    items.push({ type: 'line' });
                    items.push({ title: 'Insert row above', onclick: function() { obj.insertRow(1, y, true); } });
                    items.push({ title: 'Insert row below', onclick: function() { obj.insertRow(1, y); } });
                    items.push({ title: 'Delete row', onclick: function() { obj.deleteRow(y); } });
                    items.push({ type: 'line' });
                    items.push({ title: 'Bold', onclick: function() { applyStyle('font-weight: bold;'); } });
                    items.push({ type: 'line' });
                    items.push({ title: 'Align Left', onclick: function() { setAlignment('left'); } });
                    items.push({ title: 'Align Center', onclick: function() { setAlignment('center'); } });
                    items.push({ title: 'Align Right', onclick: function() { setAlignment('right'); } });
                    items.push({ type: 'line' });
                    items.push({ title: 'Highlight Yellow', onclick: function() { applyStyle('background-color: #fef3c7;'); } });
                    items.push({ title: 'Highlight Green', onclick: function() { applyStyle('background-color: #d1fae5;'); } });
                    items.push({ title: 'Highlight Red', onclick: function() { applyStyle('background-color: #fee2e2;'); } });
                    items.push({ title: 'Clear style', onclick: function() { clearStyle(); } });
                    return items;
                }
            });

            // Create Issue Log spreadsheet - proportional widths to fill screen
            // Issue Log has 9 columns with relative proportions
            const issueProportions = [0.6, 0.6, 1.5, 2.0, 0.7, 0.7, 0.8, 0.8, 0.7];
            const issueTotalProp = issueProportions.reduce((a, b) => a + b, 0);
            const issueBaseUnit = (containerWidth - 50) / issueTotalProp;
            const issueColWidths = issueProportions.map(p => Math.floor(issueBaseUnit * p));

            issueTable = jspreadsheet(issuesContainer, {
                data: issuesData,
                columns: [
                    { type: 'text', width: issueColWidths[0], title: 'Issue ID', readOnly: true },
                    { type: 'text', width: issueColWidths[1], title: 'Risk ID' },
                    { type: 'text', width: issueColWidths[2], title: 'Title' },
                    { type: 'text', width: issueColWidths[3], title: 'Description', wordWrap: true },
                    { type: 'dropdown', width: issueColWidths[4], title: 'Severity', source: ['Low', 'Medium', 'High', 'Critical'] },
                    { type: 'dropdown', width: issueColWidths[5], title: 'Status', source: ['Open', 'In Progress', 'Resolved', 'Closed'] },
                    { type: 'text', width: issueColWidths[6], title: 'Assigned To' },
                    { type: 'calendar', width: issueColWidths[7], title: 'Due Date', options: { format: 'YYYY-MM-DD' } },
                    { type: 'text', width: issueColWidths[8], title: 'Evidence', readOnly: true },
                ],
                wordWrap: true,
                defaultRowHeight: 40,
                columnResize: true,
                rowResize: true,
                minDimensions: [9, 1],
                tableOverflow: true,
                tableWidth: containerWidth + 'px',
                tableHeight: 'auto',
                filters: true,
                search: false,
                updateTable: updateIssueTable,
                contextMenu: function(obj, x, y, e) {
                    let items = [];
                    items.push({ title: 'Insert row above', onclick: function() { obj.insertRow(1, y, true); } });
                    items.push({ title: 'Insert row below', onclick: function() { obj.insertRow(1, y); } });
                    items.push({ title: 'Delete row', onclick: function() { obj.deleteRow(y); } });
                    return items;
                }
            });

            // Hide issues container after initialization (RACM is default view)
            issuesContainer.style.display = 'none';

            return table;
        }

        // RACM sheet updateTable callback
        function updateRACMTable(instance, cell, col, row, val, label, cellName) {
            // Get riskId - use table if available, otherwise fallback to instance.jexcel
            let riskId = '';
            try {
                if (table) {
                    riskId = table.getValueFromCoords(0, row);
                } else if (instance && instance.jexcel) {
                    riskId = instance.jexcel.getValueFromCoords(0, row);
                }
            } catch (e) {
                console.warn('Could not get riskId in updateRACMTable:', e);
            }

            // DE Testing column (E = index 4)
            if (col == 4) {
                if (riskId && riskId.trim()) {
                    const cacheKey = `${riskId}_de_testing`;
                    const hasDoc = testDocCache[cacheKey] === true;
                    if (hasDoc) {
                        cell.innerHTML = '<span class="edit-test-doc text-emerald-600 hover:text-emerald-800 cursor-pointer text-sm font-medium" data-row="' + row + '" data-type="de_testing" data-risk="' + riskId + '"> Edit</span>';
                    } else {
                        cell.innerHTML = '<span class="create-test-doc text-emerald-600 hover:text-emerald-800 cursor-pointer text-sm" data-row="' + row + '" data-type="de_testing" data-risk="' + riskId + '">+ Create</span>';
                    }
                }
            }
            // OE Testing column (G = index 6)
            if (col == 6) {
                if (riskId && riskId.trim()) {
                    const cacheKey = `${riskId}_oe_testing`;
                    const hasDoc = testDocCache[cacheKey] === true;
                    if (hasDoc) {
                        cell.innerHTML = '<span class="edit-test-doc text-emerald-600 hover:text-emerald-800 cursor-pointer text-sm font-medium" data-row="' + row + '" data-type="oe_testing" data-risk="' + riskId + '"> Edit</span>';
                    } else {
                        cell.innerHTML = '<span class="create-test-doc text-emerald-600 hover:text-emerald-800 cursor-pointer text-sm" data-row="' + row + '" data-type="oe_testing" data-risk="' + riskId + '">+ Create</span>';
                    }
                }
            }
            // Flowchart column (N = index 13)
            if (col == 13) {
                if (val && val.trim()) {
                    cell.innerHTML = '<a href="/flowchart/' + encodeURIComponent(val) + '" target="_blank" class="text-primary-600 hover:text-primary-800 underline text-sm">' + val + '</a>';
                } else {
                    if (riskId && riskId.trim()) {
                        cell.innerHTML = '<span class="create-flowchart text-cyan-600 hover:text-cyan-800 cursor-pointer text-sm" data-row="' + row + '">+ Create</span>';
                    }
                }
            }
            // Task column (O = index 14)
            if (col == 14) {
                if (val && val.trim()) {
                    cell.innerHTML = '<span class="edit-task text-violet-600 hover:text-violet-800 cursor-pointer text-sm" data-task="' + val + '" data-row="' + row + '">Edit Task</span>';
                } else {
                    if (riskId && riskId.trim()) {
                        cell.innerHTML = '<span class="create-task text-violet-600 hover:text-violet-800 cursor-pointer text-sm" data-row="' + row + '">+ Add Task</span>';
                    }
                }
            }
            // Status column styling (I = index 8)
            if (col == 8) {
                const status = val ? val : '';
                if (status === 'Effective') {
                    cell.style.backgroundColor = '#d1fae5';
                    cell.style.color = '#065f46';
                } else if (status === 'Not Effective') {
                    cell.style.backgroundColor = '#fee2e2';
                    cell.style.color = '#991b1b';
                } else if (status === 'Not Complete') {
                    cell.style.backgroundColor = '#fef3c7';
                    cell.style.color = '#92400e';
                }
            }
            // Evidence column (P = index 15) - shows attachment count for risks
            if (col == 15 && riskId && riskId.trim()) {
                const attachCount = riskAttachmentCache[riskId.toUpperCase()] || 0;
                if (attachCount > 0) {
                    cell.innerHTML = '<span class="view-risk-attachments text-amber-600 hover:text-amber-800 cursor-pointer text-sm font-medium" data-row="' + row + '" data-risk="' + riskId + '"> ' + attachCount + ' file' + (attachCount > 1 ? 's' : '') + '</span>';
                } else {
                    cell.innerHTML = '<span class="view-risk-attachments text-amber-600 hover:text-amber-800 cursor-pointer text-sm" data-row="' + row + '" data-risk="' + riskId + '">+ Attach</span>';
                }
            }
        }

        // Issue Log sheet updateTable callback
        let issueDocCache = {}; // Cache for issue documentation existence
        let issueAttachmentCache = {}; // Cache for attachment counts

        function updateIssueTable(instance, cell, col, row, val, label, cellName) {
            // Get issueId from column 0
            let issueId = '';
            try {
                if (issueTable) {
                    issueId = issueTable.getValueFromCoords(0, row);
                } else if (instance && instance.jexcel) {
                    issueId = instance.jexcel.getValueFromCoords(0, row);
                }
            } catch (e) {}

            // Severity column styling (col 4)
            if (col == 4) {
                const severity = val ? val : '';
                if (severity === 'Critical') {
                    cell.style.backgroundColor = '#fee2e2';
                    cell.style.color = '#991b1b';
                } else if (severity === 'High') {
                    cell.style.backgroundColor = '#ffedd5';
                    cell.style.color = '#c2410c';
                } else if (severity === 'Medium') {
                    cell.style.backgroundColor = '#fef3c7';
                    cell.style.color = '#92400e';
                } else if (severity === 'Low') {
                    cell.style.backgroundColor = '#d1fae5';
                    cell.style.color = '#065f46';
                }
            }
            // Status column styling (col 5)
            if (col == 5) {
                const status = val ? val : '';
                if (status === 'Closed' || status === 'Resolved') {
                    cell.style.backgroundColor = '#d1fae5';
                    cell.style.color = '#065f46';
                } else if (status === 'In Progress') {
                    cell.style.backgroundColor = '#dbeafe';
                    cell.style.color = '#1e40af';
                } else if (status === 'Open') {
                    cell.style.backgroundColor = '#fee2e2';
                    cell.style.color = '#991b1b';
                }
            }
            // Evidence column (col 8) - shows attachment count
            if (col == 8 && issueId && issueId.trim()) {
                const attachCount = issueAttachmentCache[issueId] || 0;
                if (attachCount > 0) {
                    cell.innerHTML = '<span class="view-attachments text-amber-600 hover:text-amber-800 cursor-pointer text-sm font-medium" data-row="' + row + '" data-issue="' + issueId + '"> ' + attachCount + ' file' + (attachCount > 1 ? 's' : '') + '</span>';
                } else {
                    cell.innerHTML = '<span class="view-attachments text-amber-600 hover:text-amber-800 cursor-pointer text-sm" data-row="' + row + '" data-issue="' + issueId + '">+ Attach</span>';
                }
            }
        }

        // Handle RACM changes - auto-create issue when checkbox ticked
        async function onRACMChange(instance, cell, x, y, value) {
            // Raise Issue? checkbox is column 11 (value can be true, 'true', or 1)
            if (x == 11 && (value === true || value === 'true' || value === 1 || value === '1')) {
                // Use global table variable since it's definitely set by now
                const riskId = table.getValueFromCoords(0, y);
                console.log('Raise Issue checkbox ticked for row', y, 'risk:', riskId);
                if (riskId && riskId.trim()) {
                    try {
                        const response = await fetch(`/api/issues/from-risk/${encodeURIComponent(riskId)}`, {
                            method: 'POST'
                        });
                        const data = await response.json();
                        if (data.status === 'created') {
                            showToast(`Issue ${data.issue_id} created for ${riskId}`, 'success');
                            // Refresh the Issue Log tab
                            await refreshIssueLog();
                        } else if (data.status === 'exists') {
                            showToast(`Issue already exists for ${riskId}`, 'info');
                        }
                    } catch (error) {
                        console.error('Error creating issue:', error);
                    }
                }
            }
        }

        // Refresh just the Issue Log sheet
        async function refreshIssueLog() {
            const response = await fetch('/api/data');
            const allData = await response.json();
            if (issueTable) {
                const issuesData = trimEmptyRows(allData.issues || [], ['', '', '', '', 'Medium', 'Open', '', '', '']);
                issueTable.setData(issuesData);
                // Reload documentation status
                await loadIssueDocStatus();
            }
        }

        // Save data to server (both sheets)
        async function saveData() {
            const racmData = table.getData();
            const issuesData = issueTable.getData();
            await fetch('/api/data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ racm: racmData, issues: issuesData })
            });
            showToast('Data saved successfully!', 'success');
        }

        // Export to Excel (both sheets)
        function exportExcel() {
            const racmData = table.getData();
            const issuesData = issueTable.getData();
            const wb = XLSX.utils.book_new();

            // Add RACM sheet
            const racmWs = XLSX.utils.aoa_to_sheet(racmData);
            XLSX.utils.book_append_sheet(wb, racmWs, "RACM");

            // Add Issue Log sheet
            const issuesWs = XLSX.utils.aoa_to_sheet(issuesData);
            XLSX.utils.book_append_sheet(wb, issuesWs, "Issue Log");

            XLSX.writeFile(wb, "risk_control_matrix.xlsx");
            showToast('Exported to Excel!', 'success');
        }

        // Import from Excel
        function importExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });

                // Import RACM sheet
                if (workbook.SheetNames.includes('RACM')) {
                    const racmSheet = workbook.Sheets['RACM'];
                    const racmData = XLSX.utils.sheet_to_json(racmSheet, { header: 1 });
                    table.setData(racmData);
                } else if (workbook.SheetNames[0]) {
                    // Fallback to first sheet
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    table.setData(data);
                }

                // Import Issue Log sheet if present
                if (workbook.SheetNames.includes('Issue Log')) {
                    const issuesSheet = workbook.Sheets['Issue Log'];
                    const issuesData = XLSX.utils.sheet_to_json(issuesSheet, { header: 1 });
                    issueTable.setData(issuesData);
                }

                showToast('Imported from Excel!', 'success');
            };
            reader.readAsBinaryString(file);
            event.target.value = '';
        }

        function addRow() {
            const activeTable = getActiveTable();
            if (activeTable) activeTable.insertRow();
        }

        function searchTable(query) {
            const activeTable = getActiveTable();
            if (activeTable) {
                activeTable.search(query);
            }

            // Also search kanban items if on plan tab
            if (currentTab === 'plan') {
                searchKanban(query);
            }
        }

        function searchKanban(query) {
            const kanbanItems = document.querySelectorAll('#kanban-board .kanban-item');
            const lowerQuery = query.toLowerCase();

            kanbanItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (!query || text.includes(lowerQuery)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function mergeSelected() {
            // Get highlighted cells from the table
            const highlighted = table.getSelectedColumns();
            const selected = table.getSelectedRows();

            // Try to get selection from selectedCell property
            let sel = table.selectedCell;

            // If selectedCell doesn't have proper range, try to get from DOM
            if (!sel || sel.length < 4) {
                const selectedCells = document.querySelectorAll('#spreadsheet .jexcel tbody td.highlight');
                if (selectedCells.length > 1) {
                    let minX = Infinity, minY = Infinity, maxX = -1, maxY = -1;
                    selectedCells.forEach(cell => {
                        const x = parseInt(cell.dataset.x);
                        const y = parseInt(cell.dataset.y);
                        if (!isNaN(x) && !isNaN(y)) {
                            minX = Math.min(minX, x);
                            minY = Math.min(minY, y);
                            maxX = Math.max(maxX, x);
                            maxY = Math.max(maxY, y);
                        }
                    });
                    if (minX !== Infinity) {
                        sel = [minX, minY, maxX, maxY];
                    }
                }
            }

            if (sel && sel.length >= 4) {
                const x1 = Math.min(sel[0], sel[2]);
                const y1 = Math.min(sel[1], sel[3]);
                const x2 = Math.max(sel[0], sel[2]);
                const y2 = Math.max(sel[1], sel[3]);
                const colspan = x2 - x1 + 1;
                const rowspan = y2 - y1 + 1;

                if (colspan === 1 && rowspan === 1) {
                    showToast('Please select multiple cells to merge', 'warning');
                    return;
                }

                const cellName = jspreadsheet.getColumnNameFromId([x1, y1]);
                table.setMerge(cellName, colspan, rowspan);
                showToast('Cells merged!', 'success');
            } else {
                showToast('Please select multiple cells to merge (click and drag)', 'warning');
            }
        }

        function unmergeSelected() {
            let sel = table.selectedCell;
            if (!sel || sel.length < 2) {
                const selectedCell = document.querySelector('#spreadsheet .jexcel tbody td.highlight');
                if (selectedCell) {
                    const x = parseInt(selectedCell.dataset.x);
                    const y = parseInt(selectedCell.dataset.y);
                    if (!isNaN(x) && !isNaN(y)) {
                        sel = [x, y];
                    }
                }
            }
            if (sel && sel.length >= 2) {
                const cellName = jspreadsheet.getColumnNameFromId([sel[0], sel[1]]);
                table.removeMerge(cellName);
                showToast('Cells unmerged!', 'success');
            }
        }

        function applyStyle(style) {
            const sel = table.selectedCell;
            if (sel && sel.length === 4) {
                const x1 = Math.min(sel[0], sel[2]);
                const y1 = Math.min(sel[1], sel[3]);
                const x2 = Math.max(sel[0], sel[2]);
                const y2 = Math.max(sel[1], sel[3]);
                for (let y = y1; y <= y2; y++) {
                    for (let x = x1; x <= x2; x++) {
                        const cellEl = table.getCellFromCoords(x, y);
                        if (cellEl) {
                            cellEl.style.cssText += style;
                        }
                    }
                }
            }
        }

        function clearStyle() {
            const sel = table.selectedCell;
            if (sel && sel.length === 4) {
                const x1 = Math.min(sel[0], sel[2]);
                const y1 = Math.min(sel[1], sel[3]);
                const x2 = Math.max(sel[0], sel[2]);
                const y2 = Math.max(sel[1], sel[3]);
                for (let y = y1; y <= y2; y++) {
                    for (let x = x1; x <= x2; x++) {
                        const cellEl = table.getCellFromCoords(x, y);
                        if (cellEl) {
                            cellEl.style.cssText = '';
                        }
                    }
                }
            }
        }

        function setAlignment(align) {
            const sel = table.selectedCell;
            if (sel && sel.length === 4) {
                const x1 = Math.min(sel[0], sel[2]);
                const y1 = Math.min(sel[1], sel[3]);
                const x2 = Math.max(sel[0], sel[2]);
                const y2 = Math.max(sel[1], sel[3]);
                for (let y = y1; y <= y2; y++) {
                    for (let x = x1; x <= x2; x++) {
                        const cellEl = table.getCellFromCoords(x, y);
                        if (cellEl) {
                            cellEl.style.textAlign = align;
                        }
                    }
                }
            }
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast rounded-lg shadow-lg p-4 flex items-center gap-3 ${
                type === 'success' ? 'bg-emerald-600 text-white' :
                type === 'error' ? 'bg-red-600 text-white' :
                type === 'warning' ? 'bg-amber-500 text-white' :
                'bg-slate-700 text-white'
            }`;

            const icons = {
                success: '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />',
                error: '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />',
                warning: '<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />',
                info: '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />'
            };

            toast.innerHTML = `
                <svg class="h-5 w-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">${icons[type] || icons.info}</svg>
                <p class="text-sm font-medium flex-1">${message}</p>
                <button onclick="this.parentElement.remove()" class="text-white/70 hover:text-white">
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // Initialize on load
        init().then(() => {
            // Load test document status after table is ready
            setTimeout(() => loadTestDocStatus(), 500);
        });

        // Close kanban modal when clicking backdrop
        document.getElementById('kanbanEditModal').addEventListener('click', function(e) {
            if (e.target === this) closeKanbanModal();
        });

        // Handle window resize - recalculate column widths
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                const wrapper = document.getElementById('spreadsheet');
                const containerWidth = wrapper.offsetWidth - 2;

                // Recalculate and resize RACM table columns
                if (table) {
                    const racmProportions = [0.5, 1.2, 0.6, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.6, 0.8, 0.6, 0.5, 0.8, 0.6, 0.7];
                    const racmTotalProp = racmProportions.reduce((a, b) => a + b, 0);
                    const racmBaseUnit = (containerWidth - 50) / racmTotalProp;
                    racmProportions.forEach((p, i) => {
                        table.setWidth(i, Math.floor(racmBaseUnit * p));
                    });
                }

                // Recalculate and resize Issues table columns
                if (issueTable) {
                    const issueProportions = [0.6, 0.6, 1.5, 2.0, 0.7, 0.7, 0.8, 0.8, 0.7];
                    const issueTotalProp = issueProportions.reduce((a, b) => a + b, 0);
                    const issueBaseUnit = (containerWidth - 50) / issueTotalProp;
                    issueProportions.forEach((p, i) => {
                        issueTable.setWidth(i, Math.floor(issueBaseUnit * p));
                    });
                }
            }, 150);
        });

        // Handle click events for spreadsheet links
        document.getElementById('spreadsheet').addEventListener('click', function(e) {
            if (e.target.classList.contains('create-flowchart')) {
                const row = parseInt(e.target.getAttribute('data-row'));
                const riskId = table.getValueFromCoords(0, row);
                if (riskId) {
                    const flowchartName = riskId.replace(/\s+/g, '-').toLowerCase() + '-walkthrough';
                    table.setValueFromCoords(13, row, flowchartName);
                    window.open('/flowchart/' + encodeURIComponent(flowchartName), '_blank');
                    saveData();
                }
            }
            if (e.target.classList.contains('create-task')) {
                const row = parseInt(e.target.getAttribute('data-row'));
                openTaskModal(row, null);
            }
            if (e.target.classList.contains('edit-task')) {
                const row = parseInt(e.target.getAttribute('data-row'));
                const taskId = e.target.getAttribute('data-task');
                openTaskModal(row, taskId);
            }
            // Test Document handlers
            if (e.target.classList.contains('create-test-doc') || e.target.classList.contains('edit-test-doc')) {
                const row = parseInt(e.target.getAttribute('data-row'));
                const docType = e.target.getAttribute('data-type');
                const riskCode = e.target.getAttribute('data-risk');
                openTestDocModal(row, riskCode, docType);
            }
            // Risk Attachments handler
            if (e.target.classList.contains('view-risk-attachments')) {
                const riskId = e.target.getAttribute('data-risk');
                if (riskId) {
                    openAttachmentsModal(riskId, 'risk');
                }
            }
        });

        // Task Modal Functions
        async function openTaskModal(row, taskId) {
            const riskId = table.getValueFromCoords(0, row);
            const riskDesc = table.getValueFromCoords(1, row);
            const controlDesc = table.getValueFromCoords(2, row);

            document.getElementById('taskRow').value = row;
            document.getElementById('taskId').value = taskId || '';

            if (taskId) {
                document.getElementById('taskModalTitle').textContent = 'Edit Task';
                const response = await fetch(`/api/kanban/default/task/${taskId}`);
                const task = await response.json();
                if (task) {
                    document.getElementById('taskTitle').value = task.title || '';
                    document.getElementById('taskDescription').value = task.description || '';
                    document.getElementById('taskPriority').value = task.priority || 'medium';
                    document.getElementById('taskAssignee').value = task.assignee || '';
                    document.getElementById('taskDueDate').value = task.dueDate || '';
                    document.getElementById('taskStatus').classList.remove('hidden');
                    document.getElementById('taskStatusText').textContent = task.columnTitle || 'Unknown';
                    document.getElementById('viewOnBoardLink').classList.remove('hidden');
                }
            } else {
                document.getElementById('taskModalTitle').textContent = 'Add Task';
                document.getElementById('taskTitle').value = `Test: ${riskId} - ${controlDesc || riskDesc}`.substring(0, 100);
                document.getElementById('taskDescription').value = `Risk: ${riskDesc}\nControl: ${controlDesc}`;
                document.getElementById('taskPriority').value = 'medium';
                document.getElementById('taskAssignee').value = '';
                document.getElementById('taskDueDate').value = '';
                document.getElementById('taskStatus').classList.add('hidden');
                document.getElementById('viewOnBoardLink').classList.add('hidden');
            }

            document.getElementById('taskModal').classList.remove('hidden');
            document.getElementById('taskModal').classList.add('flex');
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.add('hidden');
            document.getElementById('taskModal').classList.remove('flex');
        }

        async function saveTask() {
            const row = parseInt(document.getElementById('taskRow').value);
            const taskId = document.getElementById('taskId').value;
            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const priority = document.getElementById('taskPriority').value;
            const assignee = document.getElementById('taskAssignee').value.trim();
            const dueDate = document.getElementById('taskDueDate').value;

            if (!title) {
                showToast('Please enter a title', 'warning');
                return;
            }

            const riskId = table.getValueFromCoords(0, row);
            const taskData = { title, description, priority, assignee, dueDate, riskId, racmRow: row };

            if (taskId) {
                await fetch(`/api/kanban/default/task/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });
                showToast('Task updated!', 'success');
            } else {
                const response = await fetch('/api/kanban/default/task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });
                const result = await response.json();
                table.setValueFromCoords(14, row, result.taskId);
                await saveData();
                showToast('Task created!', 'success');
            }
            closeTaskModal();
        }

        document.getElementById('taskModal').addEventListener('click', function(e) {
            if (e.target === this) closeTaskModal();
        });

        // ==================== Test Document Editor Functions ====================
        let quillEditor = null;
        let testDocCache = {}; // Cache for document existence status
        let riskAttachmentCache = {}; // Cache for risk attachment counts

        async function checkTestDocExists(riskCode, docType) {
            const cacheKey = `${riskCode}_${docType}`;
            if (testDocCache[cacheKey] !== undefined) {
                return testDocCache[cacheKey];
            }
            try {
                const response = await fetch(`/api/test-document/${encodeURIComponent(riskCode)}/${docType}/exists`);
                const data = await response.json();
                testDocCache[cacheKey] = data.exists;
                return data.exists;
            } catch (e) {
                return false;
            }
        }

        async function loadTestDocStatus() {
            // Load document status for all rows into cache, then refresh table
            const data = table.getData();
            const promises = [];
            for (let row = 0; row < data.length; row++) {
                const riskCode = data[row][0];
                if (riskCode && riskCode.trim()) {
                    // Pre-populate cache for DE and OE Testing columns
                    promises.push(checkTestDocExists(riskCode, 'de_testing'));
                    promises.push(checkTestDocExists(riskCode, 'oe_testing'));
                }
            }
            await Promise.all(promises);
            // Force complete re-render by setting data again
            table.setData(data);
            // Also load risk attachment counts
            await loadRiskAttachmentCounts();
        }

        async function loadRiskAttachmentCounts() {
            // Load attachment counts for all risks
            if (!table) return;
            const data = table.getData();
            const promises = [];
            for (let row = 0; row < data.length; row++) {
                const riskId = data[row][0];
                if (riskId && riskId.trim()) {
                    promises.push(
                        fetch(`/api/risks/${encodeURIComponent(riskId)}/attachments`)
                            .then(r => r.json())
                            .then(attachments => {
                                riskAttachmentCache[riskId.toUpperCase()] = attachments.length;
                            })
                            .catch(() => {
                                riskAttachmentCache[riskId.toUpperCase()] = 0;
                            })
                    );
                }
            }
            await Promise.all(promises);
            // Re-render
            table.setData(data);
        }

        async function openTestDocModal(row, riskCode, docType) {
            currentIssueDoc = null; // Reset - we're editing a test doc, not an issue doc
            const riskDesc = table.getValueFromCoords(1, row);
            const typeLabel = docType === 'de_testing' ? 'Design Effectiveness Testing' : 'Operational Effectiveness Testing';

            document.getElementById('testDocModalTitle').textContent = typeLabel;
            document.getElementById('testDocModalSubtitle').textContent = `Risk: ${riskCode} - ${riskDesc || 'No description'}`;
            document.getElementById('testDocRiskCode').value = riskCode;
            document.getElementById('testDocType').value = docType;

            // Initialize Quill if not already done
            if (!quillEditor) {
                quillEditor = new Quill('#testDocEditor', {
                    theme: 'snow',
                    placeholder: 'Document your testing procedures, findings, and evidence...',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'indent': '-1'}, { 'indent': '+1' }],
                            ['blockquote', 'code-block'],
                            ['link'],
                            ['clean']
                        ]
                    }
                });
            }

            // Load existing content
            try {
                const response = await fetch(`/api/test-document/${encodeURIComponent(riskCode)}/${docType}`);
                const data = await response.json();
                if (data.content) {
                    quillEditor.root.innerHTML = data.content;
                } else {
                    quillEditor.root.innerHTML = '';
                }
            } catch (e) {
                quillEditor.root.innerHTML = '';
            }

            document.getElementById('testDocModal').classList.remove('hidden');
            document.getElementById('testDocModal').classList.add('flex');
        }

        function closeTestDocModal() {
            document.getElementById('testDocModal').classList.add('hidden');
            document.getElementById('testDocModal').classList.remove('flex');
            // Reset maximize state and custom size on close
            const container = document.querySelector('#testDocModal .doc-modal-container');
            container.classList.remove('maximized');
            container.style.width = '';
            container.style.height = '';
            document.getElementById('testDocMaximizeIcon').classList.remove('hidden');
            document.getElementById('testDocMinimizeIcon').classList.add('hidden');
        }

        function toggleTestDocModalMaximize() {
            const container = document.querySelector('#testDocModal .doc-modal-container');
            const maxIcon = document.getElementById('testDocMaximizeIcon');
            const minIcon = document.getElementById('testDocMinimizeIcon');

            container.classList.toggle('maximized');

            if (container.classList.contains('maximized')) {
                maxIcon.classList.add('hidden');
                minIcon.classList.remove('hidden');
            } else {
                maxIcon.classList.remove('hidden');
                minIcon.classList.add('hidden');
            }
        }

        // Resize handler for document modal
        let docModalResizing = false;
        let docModalStartX, docModalStartY, docModalStartW, docModalStartH;

        document.addEventListener('mousedown', function(e) {
            if (e.target.id === 'docModalResize') {
                const container = document.querySelector('#testDocModal .doc-modal-container');
                if (!container || container.classList.contains('maximized')) return;

                docModalResizing = true;
                docModalStartX = e.clientX;
                docModalStartY = e.clientY;
                docModalStartW = container.offsetWidth;
                docModalStartH = container.offsetHeight;

                document.body.style.cursor = 'nwse-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
                e.stopPropagation();
            }
        });

        document.addEventListener('mousemove', function(e) {
            if (!docModalResizing) return;

            const container = document.querySelector('#testDocModal .doc-modal-container');
            if (!container) return;

            const newW = Math.max(400, Math.min(window.innerWidth - 40, docModalStartW + (e.clientX - docModalStartX)));
            const newH = Math.max(300, Math.min(window.innerHeight - 40, docModalStartH + (e.clientY - docModalStartY)));

            container.style.width = newW + 'px';
            container.style.height = newH + 'px';
        });

        document.addEventListener('mouseup', function() {
            if (docModalResizing) {
                docModalResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });

        async function saveTestDocument() {
            const riskCode = document.getElementById('testDocRiskCode').value;
            const docType = document.getElementById('testDocType').value;
            const content = quillEditor.root.innerHTML;

            try {
                const response = await fetch(`/api/test-document/${encodeURIComponent(riskCode)}/${docType}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                const data = await response.json();

                if (data.status === 'saved') {
                    showToast('Document saved successfully!', 'success');
                    // Update cache and refresh cells
                    testDocCache[`${riskCode}_${docType}`] = content.trim().length > 0;
                    await loadTestDocStatus();
                    closeTestDocModal();
                } else {
                    showToast('Error saving document: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                showToast('Error saving document: ' + e.message, 'error');
            }
        }

        document.getElementById('testDocModal').addEventListener('click', function(e) {
            // Don't close if we're in the middle of resizing
            if (e.target === this && !docModalResizing) closeTestDocModal();
        });

        // ==================== Issue Documentation Functions ====================
        let currentIssueDoc = null; // Track whether we're editing issue doc or test doc

        async function checkIssueDocExists(issueId) {
            const cacheKey = issueId.toUpperCase();
            if (issueDocCache[cacheKey] !== undefined) {
                return issueDocCache[cacheKey];
            }
            try {
                const response = await fetch(`/api/issues/${encodeURIComponent(issueId)}/documentation/exists`);
                const data = await response.json();
                issueDocCache[cacheKey] = data.exists;
                return data.exists;
            } catch (e) {
                return false;
            }
        }

        async function loadIssueDocStatus() {
            // Load documentation status for all issues into cache
            if (!issueTable) return;
            const data = issueTable.getData();
            const promises = [];
            for (let row = 0; row < data.length; row++) {
                const issueId = data[row][0];
                if (issueId && issueId.trim()) {
                    promises.push(checkIssueDocExists(issueId));
                }
            }
            await Promise.all(promises);
            // Force re-render
            issueTable.setData(data);
        }

        async function openIssueDocModal(issueId) {
            currentIssueDoc = issueId;

            // Get issue details
            const issueData = issueTable.getData();
            let issueTitle = '';
            for (let row of issueData) {
                if (row[0] && row[0].toUpperCase() === issueId.toUpperCase()) {
                    issueTitle = row[2] || 'No title';
                    break;
                }
            }

            document.getElementById('testDocModalTitle').textContent = 'Issue Documentation & Evidence';
            document.getElementById('testDocModalSubtitle').textContent = `Issue: ${issueId} - ${issueTitle}`;
            document.getElementById('testDocRiskCode').value = '';
            document.getElementById('testDocType').value = '';

            // Initialize Quill if not already done
            if (!quillEditor) {
                quillEditor = new Quill('#testDocEditor', {
                    theme: 'snow',
                    placeholder: 'Document findings, evidence, root cause analysis, and remediation plans...',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'indent': '-1'}, { 'indent': '+1' }],
                            ['blockquote', 'code-block'],
                            ['link'],
                            ['clean']
                        ]
                    }
                });
            }

            // Load existing content
            try {
                const response = await fetch(`/api/issues/${encodeURIComponent(issueId)}/documentation`);
                const data = await response.json();
                if (data.documentation) {
                    quillEditor.root.innerHTML = data.documentation;
                } else {
                    quillEditor.root.innerHTML = '';
                }
            } catch (e) {
                quillEditor.root.innerHTML = '';
            }

            document.getElementById('testDocModal').classList.remove('hidden');
            document.getElementById('testDocModal').classList.add('flex');
        }

        // Override saveTestDocument to handle both test docs and issue docs
        saveTestDocument = async function() {
            if (currentIssueDoc) {
                // Save issue documentation
                const content = quillEditor.root.innerHTML;
                try {
                    const response = await fetch(`/api/issues/${encodeURIComponent(currentIssueDoc)}/documentation`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ documentation: content })
                    });
                    const data = await response.json();
                    if (data.status === 'saved') {
                        showToast('Documentation saved successfully!', 'success');
                        issueDocCache[currentIssueDoc.toUpperCase()] = content.trim().length > 0;
                        await loadIssueDocStatus();
                        currentIssueDoc = null;
                        closeTestDocModal();
                    } else {
                        showToast('Error saving documentation', 'error');
                    }
                } catch (e) {
                    showToast('Error saving documentation: ' + e.message, 'error');
                }
            } else {
                // Original test document save
                const riskCode = document.getElementById('testDocRiskCode').value;
                const docType = document.getElementById('testDocType').value;
                const content = quillEditor.root.innerHTML;

                try {
                    const response = await fetch(`/api/test-document/${encodeURIComponent(riskCode)}/${docType}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content })
                    });
                    const data = await response.json();

                    if (data.status === 'saved') {
                        showToast('Document saved successfully!', 'success');
                        testDocCache[`${riskCode}_${docType}`] = content.trim().length > 0;
                        await loadTestDocStatus();
                        closeTestDocModal();
                    } else {
                        showToast('Error saving document: ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (e) {
                    showToast('Error saving document: ' + e.message, 'error');
                }
            }
        };

        // Click handler for Issue Log spreadsheet
        document.getElementById('spreadsheet-issues').addEventListener('click', function(e) {
            if (e.target.classList.contains('add-issue-doc') || e.target.classList.contains('edit-issue-doc')) {
                const issueId = e.target.getAttribute('data-issue');
                if (issueId) {
                    openIssueDocModal(issueId);
                }
            }
            if (e.target.classList.contains('view-attachments')) {
                const issueId = e.target.getAttribute('data-issue');
                if (issueId) {
                    openAttachmentsModal(issueId, 'issue');
                }
            }
        });

        // ==================== Evidence Panel Functions ====================

        let evidencePanelOpen = false;
        let currentEvidenceItemId = null;
        let currentEvidenceItemType = 'risk'; // 'risk' or 'issue'
        let currentEvidenceCategory = 'planning'; // 'planning', 'de', 'oe', 'issue'

        async function loadAttachmentCounts() {
            // Load attachment counts for all issues
            if (!issueTable) return;
            const data = issueTable.getData();
            for (let row = 0; row < data.length; row++) {
                const issueId = data[row][0];
                if (issueId && issueId.trim()) {
                    try {
                        const response = await fetch(`/api/issues/${encodeURIComponent(issueId)}/attachments`);
                        const attachments = await response.json();
                        issueAttachmentCache[issueId.toUpperCase()] = attachments.length;
                    } catch (e) {
                        issueAttachmentCache[issueId.toUpperCase()] = 0;
                    }
                }
            }
            // Re-render
            issueTable.setData(data);
        }

        // Open evidence panel - for RACM risks (shows Planning, DE, OE tabs)
        async function openAttachmentsModal(itemId, type = 'issue') {
            currentEvidenceItemId = itemId;
            currentEvidenceItemType = type;
            document.getElementById('evidenceItemId').value = itemId;
            document.getElementById('evidenceItemType').value = type;

            const panel = document.getElementById('evidencePanel');
            const backdrop = document.getElementById('evidenceBackdrop');

            if (type === 'issue') {
                // Get issue title
                const data = issueTable.getData();
                let issueTitle = '';
                for (let row of data) {
                    if (row[0] && row[0].toUpperCase() === itemId.toUpperCase()) {
                        issueTitle = row[2] || 'No title';
                        break;
                    }
                }
                document.getElementById('evidencePanelTitle').textContent = 'Issue Evidence';
                document.getElementById('evidencePanelSubtitle').textContent = `${itemId} - ${issueTitle}`;
                // Show only Issue tab for issues
                document.getElementById('tab-planning').classList.add('hidden');
                document.getElementById('tab-de').classList.add('hidden');
                document.getElementById('tab-oe').classList.add('hidden');
                document.getElementById('tab-issue').classList.remove('hidden');
                currentEvidenceCategory = 'issue';
                switchEvidenceTab('issue');
            } else {
                // Get risk description
                const data = table.getData();
                let riskDesc = '';
                for (let row of data) {
                    if (row[0] && row[0].toUpperCase() === itemId.toUpperCase()) {
                        riskDesc = row[1] || 'No description';
                        break;
                    }
                }
                document.getElementById('evidencePanelTitle').textContent = 'Risk Evidence & Working Papers';
                document.getElementById('evidencePanelSubtitle').textContent = `${itemId} - ${riskDesc}`;
                // Show Planning, DE, OE tabs for risks
                document.getElementById('tab-planning').classList.remove('hidden');
                document.getElementById('tab-de').classList.remove('hidden');
                document.getElementById('tab-oe').classList.remove('hidden');
                document.getElementById('tab-issue').classList.add('hidden');
                currentEvidenceCategory = 'planning';
                switchEvidenceTab('planning');
            }

            // Show panel
            panel.classList.remove('-translate-x-full');
            backdrop.classList.remove('hidden');
            evidencePanelOpen = true;
        }

        function closeEvidencePanel() {
            const panel = document.getElementById('evidencePanel');
            const backdrop = document.getElementById('evidenceBackdrop');
            panel.classList.add('-translate-x-full');
            backdrop.classList.add('hidden');
            evidencePanelOpen = false;
        }

        // Alias for backward compatibility
        function closeAttachmentsModal() {
            closeEvidencePanel();
        }

        function switchEvidenceTab(category) {
            currentEvidenceCategory = category;

            // Update tab styles
            const tabs = ['planning', 'de', 'oe', 'issue'];
            tabs.forEach(t => {
                const tab = document.getElementById(`tab-${t}`);
                if (tab) {
                    if (t === category) {
                        tab.className = 'evidence-tab px-4 py-3 text-sm font-medium border-b-2 border-primary-500 text-primary-700';
                    } else {
                        tab.className = 'evidence-tab px-4 py-3 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700';
                    }
                }
            });

            // Update list title
            const titles = {
                'planning': 'Planning Documents',
                'de': 'Design Effectiveness Testing Documents',
                'oe': 'Operational Effectiveness Testing Documents',
                'issue': 'Issue Evidence'
            };
            document.getElementById('evidenceListTitle').textContent = titles[category] || 'Documents';

            // Refresh file list for this category
            refreshEvidenceList();
        }

        async function refreshEvidenceList() {
            const listDiv = document.getElementById('evidenceFilesList');
            const itemId = currentEvidenceItemId;
            const itemType = currentEvidenceItemType;
            const category = currentEvidenceCategory;

            try {
                let attachments = [];
                let downloadEndpoint = '';

                if (itemType === 'issue') {
                    // Issue attachments
                    const response = await fetch(`/api/issues/${encodeURIComponent(itemId)}/attachments`);
                    attachments = await response.json();
                    downloadEndpoint = '/api/attachments/';
                    issueAttachmentCache[itemId.toUpperCase()] = attachments.length;
                } else {
                    // Risk attachments - filter by category
                    const response = await fetch(`/api/risks/${encodeURIComponent(itemId)}/attachments`);
                    const allAttachments = await response.json();
                    attachments = allAttachments.filter(att => att.category === category);
                    downloadEndpoint = '/api/risk-attachments/';
                    riskAttachmentCache[itemId.toUpperCase()] = allAttachments.length;
                }

                if (attachments.length === 0) {
                    listDiv.innerHTML = '<p class="text-sm text-slate-500 italic">No files uploaded yet.</p>';
                    return;
                }

                listDiv.innerHTML = attachments.map(att => {
                    const sizeKB = Math.round(att.file_size / 1024);
                    const sizeStr = sizeKB > 1024 ? `${(sizeKB / 1024).toFixed(1)} MB` : `${sizeKB} KB`;
                    const icon = getFileIcon(att.mime_type);
                    return `
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">${icon}</span>
                                <div>
                                    <a href="${downloadEndpoint}${att.id}" target="_blank" class="text-sm font-medium text-slate-900 hover:text-amber-600">${att.original_filename}</a>
                                    <p class="text-xs text-slate-500">${sizeStr}  ${new Date(att.uploaded_at).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <button onclick="deleteEvidenceFile(${att.id})" class="text-slate-400 hover:text-red-600 transition-colors" title="Delete">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                listDiv.innerHTML = '<p class="text-sm text-red-500">Error loading files.</p>';
            }
        }

        function getFileIcon(mimeType) {
            if (!mimeType) return '';
            if (mimeType.includes('pdf')) return '';
            if (mimeType.includes('word') || mimeType.includes('document')) return '';
            if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return '';
            if (mimeType.includes('image')) return '';
            if (mimeType.includes('email') || mimeType.includes('message')) return '';
            if (mimeType.includes('zip') || mimeType.includes('archive')) return '';
            return '';
        }

        async function deleteEvidenceFile(attachmentId) {
            if (!confirm('Delete this file?')) return;

            try {
                const deleteEndpoint = currentEvidenceItemType === 'issue'
                    ? `/api/attachments/${attachmentId}`
                    : `/api/risk-attachments/${attachmentId}`;
                await fetch(deleteEndpoint, { method: 'DELETE' });
                showToast('File deleted', 'success');
                await refreshEvidenceList();
                // Update the appropriate table display
                if (currentEvidenceItemType === 'issue') {
                    const data = issueTable.getData();
                    issueTable.setData(data);
                } else {
                    const data = table.getData();
                    table.setData(data);
                }
            } catch (e) {
                showToast('Error deleting file', 'error');
            }
        }

        // File upload handler for evidence panel
        document.getElementById('evidenceFileInput').addEventListener('change', async function(e) {
            const files = e.target.files;
            const itemId = currentEvidenceItemId;
            const itemType = currentEvidenceItemType;
            const category = currentEvidenceCategory;
            if (!files.length || !itemId) return;

            const uploadUrl = itemType === 'issue'
                ? `/api/issues/${encodeURIComponent(itemId)}/attachments`
                : `/api/risks/${encodeURIComponent(itemId)}/attachments`;

            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);
                if (itemType === 'risk') {
                    formData.append('category', category);
                }

                try {
                    const response = await fetch(uploadUrl, {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (result.error) {
                        showToast(`Error: ${result.error}`, 'error');
                    } else {
                        showToast(`Uploaded: ${result.filename}`, 'success');
                    }
                } catch (err) {
                    showToast(`Upload failed: ${err.message}`, 'error');
                }
            }

            await refreshEvidenceList();
            // Update the appropriate table display
            if (itemType === 'issue') {
                const data = issueTable.getData();
                issueTable.setData(data);
            } else {
                const data = table.getData();
                table.setData(data);
            }

            // Clear the input
            e.target.value = '';
        });

        // Close panels on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (evidencePanelOpen) closeEvidencePanel();
                if (chatOpen) toggleChat();
            }
        });

        // ==================== Chat Functions ====================
        let chatOpen = false;

        function toggleChat() {
            chatOpen = !chatOpen;
            const panel = document.getElementById('chatPanel');
            const backdrop = document.getElementById('chatBackdrop');

            if (chatOpen) {
                panel.classList.remove('translate-x-full');
                backdrop.classList.remove('hidden');
                document.getElementById('chatInput').focus();
            } else {
                panel.classList.add('translate-x-full');
                backdrop.classList.add('hidden');
            }
        }

        function handleChatKeypress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addChatMessage(message, 'user');
            input.value = '';

            document.getElementById('typingIndicator').classList.remove('hidden');
            document.getElementById('chatSend').disabled = true;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const data = await response.json();

                if (data.error) {
                    addChatMessage(data.error, 'error');
                } else {
                    addChatMessage(data.response, 'assistant');
                    if (data.data_version !== undefined) {
                        await refreshSpreadsheet();
                    }
                }
            } catch (error) {
                addChatMessage('Failed to connect: ' + error.message, 'error');
            }

            document.getElementById('typingIndicator').classList.add('hidden');
            document.getElementById('chatSend').disabled = false;
        }

        async function refreshSpreadsheet() {
            const response = await fetch('/api/data');
            const allData = await response.json();
            // Set RACM data (trimmed)
            const emptyRacmRow = ['', '', '', '', '', '', '', '', '', false, '', false, false, '', '', ''];
            const racmData = trimEmptyRows(allData.racm || [], emptyRacmRow);
            table.setData(racmData);
            // Also refresh issues if available
            if (issueTable && allData.issues) {
                const issuesData = trimEmptyRows(allData.issues, ['', '', '', '', 'Medium', 'Open', '', '', '']);
                issueTable.setData(issuesData);
            }
            // Reload caches
            await loadTestDocStatus();
        }

        function addChatMessage(content, type) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex gap-3';

            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex-1"></div>
                    <div class="bg-violet-600 text-white rounded-lg p-3 max-w-[80%]">
                        <p class="text-sm">${escapeHtml(content)}</p>
                    </div>
                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-slate-200 flex items-center justify-center">
                        <svg class="h-4 w-4 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                `;
            } else if (type === 'error') {
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-red-100 flex items-center justify-center">
                        <svg class="h-4 w-4 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <div class="flex-1 bg-red-50 border border-red-200 rounded-lg p-3">
                        <p class="text-sm text-red-700">${escapeHtml(content)}</p>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-violet-100 flex items-center justify-center">
                        <svg class="h-4 w-4 text-violet-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <div class="flex-1 bg-white rounded-lg p-3 shadow-sm ring-1 ring-slate-900/5">
                        <div class="text-sm text-slate-700 prose prose-sm max-w-none">${formatMarkdown(content)}</div>
                    </div>
                `;
            }
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMarkdown(text) {
            let html = escapeHtml(text);
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/`(.*?)`/g, '<code class="bg-slate-100 px-1 rounded text-xs">$1</code>');
            html = html.replace(/\n\n/g, '</p><p class="mt-2">');
            html = html.replace(/\n/g, '<br>');
            html = html.replace(/^- (.*?)(<br>|$)/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)+/g, '<ul class="list-disc list-inside mt-1 space-y-1">$&</ul>');
            return `<p>${html}</p>`;
        }

        async function clearChat() {
            document.getElementById('chatMessages').innerHTML = `
                <div class="flex gap-3">
                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-violet-100 flex items-center justify-center">
                        <svg class="h-4 w-4 text-violet-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <div class="flex-1 bg-white rounded-lg p-3 shadow-sm ring-1 ring-slate-900/5">
                        <p class="text-sm text-slate-700">Chat cleared. How can I help with your audit?</p>
                    </div>
                </div>
            `;
            await fetch('/api/chat/clear', { method: 'POST' });
        }

        // Escape key closes panels (evidence panel handled in its section)
    </script>
</body>
</html>
