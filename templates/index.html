<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RACM - Risk and Control Matrix</title>

    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        audit: {
                            green: '#10b981',
                            amber: '#f59e0b',
                            red: '#ef4444',
                            grey: '#6b7280',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Jspreadsheet CSS -->
    <link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jspreadsheet.css" type="text/css" />
    <link rel="stylesheet" href="https://jsuites.net/v5/jsuites.css" type="text/css" />

    <!-- Quill.js CSS -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

    <style>
        /* Override Jspreadsheet styles to match theme */
        .jexcel_content, .jspreadsheet_content {
            font-family: inherit;
        }
        .jexcel tbody td, .jspreadsheet tbody td {
            font-size: 13px;
            white-space: normal !important;
            word-wrap: break-word;
            vertical-align: top;
            padding: 6px 8px;
        }
        .jexcel thead tr:first-child td, .jspreadsheet thead tr:first-child td {
            background: #1e40af !important;
            color: white !important;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            white-space: normal !important;
            word-wrap: break-word;
            vertical-align: middle;
            padding: 8px 4px;
            line-height: 1.3;
        }
        /* Filter row - second row in thead */
        .jexcel thead tr.jexcel_filter td, .jspreadsheet thead tr.jexcel_filter td {
            background: #f1f5f9 !important;
            color: #334155 !important;
            font-weight: normal;
            text-transform: none;
            padding: 4px 6px;
        }
        .jexcel thead tr.jexcel_filter td input,
        .jspreadsheet thead tr.jexcel_filter td input {
            width: 100% !important;
            padding: 6px 8px !important;
            border: 1px solid #cbd5e1 !important;
            border-radius: 4px !important;
            font-size: 12px !important;
            background: white !important;
            color: #334155 !important;
            box-sizing: border-box;
        }
        .jexcel thead tr.jexcel_filter td input:focus,
        .jspreadsheet thead tr.jexcel_filter td input:focus {
            border-color: #3b82f6 !important;
            outline: none !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2) !important;
        }
        .jexcel tbody tr:hover td, .jspreadsheet tbody tr:hover td {
            background-color: #f8fafc;
        }
        .jexcel_container, .jspreadsheet_container {
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            border: 1px solid rgb(15 23 42 / 0.05);
        }
        /* Filter row styling */
        .jexcel_filter, .jspreadsheet_filter {
            background-color: #f8fafc !important;
        }
        .jexcel_filter td, .jspreadsheet_filter td {
            background-color: #f8fafc !important;
            border-bottom: 2px solid #e2e8f0;
        }
        .jexcel_filter input, .jspreadsheet_filter input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Quill editor styling */
        #testDocEditor {
            display: flex;
            flex-direction: column;
            height: 50vh;
            min-height: 300px;
        }
        #testDocEditor .ql-toolbar.ql-snow {
            flex-shrink: 0;
            border-top: none;
            border-left: none;
            border-right: none;
            background: #f8fafc;
        }
        #testDocEditor .ql-container.ql-snow {
            font-size: 14px;
            font-family: inherit;
            flex: 1;
            overflow: hidden;
            border: none;
            border-top: 1px solid #e2e8f0;
        }
        #testDocEditor .ql-editor {
            height: 100%;
            max-height: 100%;
            overflow-y: scroll !important;
            padding: 16px;
        }

        /* Toast animations */
        .toast {
            animation: slideIn 0.3s ease-out;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body class="h-full">
    <div class="min-h-full">
        <!-- Navigation -->
        <nav class="bg-white border-b border-slate-200">
            <div class="flex h-16 items-center justify-between px-4 sm:px-6">
                <!-- Left: Logo + Nav Links -->
                <div class="flex items-center">
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <div class="h-8 w-8 rounded-lg bg-primary-600 flex items-center justify-center">
                            <svg class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-xl font-bold text-slate-900 leading-tight">RACM</span>
                            <span class="text-xs text-slate-500 -mt-0.5">Audit Toolkit</span>
                        </div>
                    </div>
                    <div class="hidden sm:flex sm:items-center sm:ml-8 sm:space-x-1">
                        <a href="/" class="bg-primary-50 text-primary-700 rounded-md px-3 py-2 text-sm font-medium">
                            Risk Matrix
                        </a>
                        <a href="/flowchart" class="text-slate-500 hover:bg-slate-100 hover:text-slate-700 rounded-md px-3 py-2 text-sm font-medium transition-colors">
                            Flowcharts
                        </a>
                        <a href="/kanban" class="text-slate-500 hover:bg-slate-100 hover:text-slate-700 rounded-md px-3 py-2 text-sm font-medium transition-colors">
                            Audit Plan
                        </a>
                    </div>
                </div>
                <!-- Right: AI Chat Toggle -->
                <div class="flex items-center gap-3">
                    <button onclick="toggleChat()" class="inline-flex items-center gap-2 rounded-md bg-violet-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-violet-500 transition-colors">
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                        </svg>
                        AI Assistant
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main content -->
        <main class="py-6">
            <div class="mx-auto px-4 sm:px-6">
                <!-- Header -->
                <div class="md:flex md:items-center md:justify-between mb-6">
                    <div class="min-w-0 flex-1">
                        <h1 class="text-2xl font-bold leading-7 text-slate-900 sm:truncate sm:text-3xl sm:tracking-tight">
                            Risk and Control Matrix
                        </h1>
                        <p class="mt-1 text-sm text-slate-500">
                            Document risks, controls, and their effectiveness
                        </p>
                    </div>
                </div>

                <!-- Toolbar -->
                <div class="mb-4 flex flex-wrap items-center gap-3">
                    <button onclick="saveData()" class="inline-flex items-center rounded-md bg-primary-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 transition-colors">
                        <svg class="-ml-0.5 mr-1.5 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                        Save
                    </button>
                    <button onclick="exportExcel()" class="inline-flex items-center rounded-md bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 transition-colors">
                        <svg class="-ml-0.5 mr-1.5 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Export Excel
                    </button>
                    <label class="inline-flex items-center rounded-md bg-slate-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-500 transition-colors cursor-pointer">
                        <svg class="-ml-0.5 mr-1.5 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        Import Excel
                        <input type="file" id="fileInput" onchange="importExcel(event)" accept=".xlsx,.xls" class="hidden">
                    </label>
                    <div class="h-6 w-px bg-slate-300"></div>
                    <button onclick="addRow()" class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-medium text-slate-700 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50 transition-colors">
                        <svg class="-ml-0.5 mr-1.5 h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Add Row
                    </button>
                    <button onclick="mergeSelected()" class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-medium text-slate-700 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50 transition-colors">
                        <svg class="-ml-0.5 mr-1.5 h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6z" />
                        </svg>
                        Merge Cells
                    </button>
                </div>

                <!-- Spreadsheet Tabs -->
                <div class="bg-white rounded-xl shadow-sm ring-1 ring-slate-900/5 overflow-hidden">
                    <div class="border-b border-slate-200 bg-slate-50">
                        <nav class="flex -mb-px" aria-label="Tabs">
                            <button id="tab-racm" onclick="switchTab('racm')" class="tab-button active px-6 py-3 text-sm font-medium border-b-2 border-primary-500 text-primary-600 bg-white">
                                RACM
                            </button>
                            <button id="tab-issues" onclick="switchTab('issues')" class="tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300">
                                Issue Log
                            </button>
                        </nav>
                    </div>
                    <div id="spreadsheet-racm"></div>
                    <div id="spreadsheet-issues" style="display: none;"></div>
                </div>

                <!-- Toast notifications -->
                <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 max-w-sm"></div>
            </div>
        </main>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 hidden items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-200 bg-slate-50">
                <h3 id="taskModalTitle" class="text-lg font-semibold text-slate-900">Add Task</h3>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="taskId">
                <input type="hidden" id="taskRow">

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Title</label>
                    <input type="text" id="taskTitle" placeholder="Task title..." class="w-full rounded-md border-slate-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                    <textarea id="taskDescription" placeholder="What needs to be done?" rows="3" class="w-full rounded-md border-slate-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Priority</label>
                        <select id="taskPriority" class="w-full rounded-md border-slate-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Due Date</label>
                        <input type="date" id="taskDueDate" class="w-full rounded-md border-slate-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Assignee</label>
                    <input type="text" id="taskAssignee" placeholder="Who is responsible?" class="w-full rounded-md border-slate-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                </div>

                <div id="taskStatus" class="hidden rounded-md bg-blue-50 p-3">
                    <p class="text-sm text-blue-700">Status: <span id="taskStatusText" class="font-medium"></span></p>
                </div>
            </div>
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex items-center justify-end gap-3">
                <a id="viewOnBoardLink" href="/kanban" target="_blank" class="hidden">
                    <button type="button" class="rounded-md bg-cyan-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-cyan-500">View on Board</button>
                </a>
                <button onclick="closeTaskModal()" class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50">Cancel</button>
                <button onclick="saveTask()" class="rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">Save Task</button>
            </div>
        </div>
    </div>

    <!-- Test Document Editor Modal -->
    <div id="testDocModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 hidden items-center justify-center overflow-y-auto py-8">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 flex flex-col" style="max-height: calc(100vh - 4rem);">
            <div class="px-6 py-4 border-b border-slate-200 bg-slate-50 flex-shrink-0 rounded-t-xl">
                <h3 id="testDocModalTitle" class="text-lg font-semibold text-slate-900">Design Effectiveness Testing</h3>
                <p id="testDocModalSubtitle" class="text-sm text-slate-500 mt-1">Risk: R001</p>
            </div>
            <div class="flex-1 overflow-y-auto flex flex-col min-h-0">
                <input type="hidden" id="testDocRiskCode">
                <input type="hidden" id="testDocType">
                <div id="testDocEditor" class="flex-1 min-h-[400px]"></div>
            </div>
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex items-center justify-end gap-3 flex-shrink-0">
                <button onclick="closeTestDocModal()" class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50">Cancel</button>
                <button onclick="saveTestDocument()" class="rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">Save Document</button>
            </div>
        </div>
    </div>

    <!-- Chat Panel -->
    <div id="chatPanel" class="fixed inset-y-0 right-0 w-full sm:w-[420px] max-w-full bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
        <!-- Chat Header -->
        <div class="flex items-center justify-between px-4 py-4 border-b border-slate-200 bg-violet-600 flex-shrink-0">
            <div class="flex items-center gap-3">
                <div class="h-8 w-8 rounded-full bg-white/20 flex items-center justify-center">
                    <svg class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                </div>
                <div>
                    <h2 class="text-base font-semibold text-white">AI Audit Assistant</h2>
                    <p class="text-xs text-violet-200">Powered by Claude</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="clearChat()" class="rounded-md p-2 text-violet-200 hover:text-white hover:bg-white/10 transition-colors" title="Clear chat">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
                <button onclick="toggleChat()" class="rounded-md p-2 text-violet-200 hover:text-white hover:bg-white/10 transition-colors">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Chat Messages -->
        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
            <div class="flex gap-3">
                <div class="flex-shrink-0 h-8 w-8 rounded-full bg-violet-100 flex items-center justify-center">
                    <svg class="h-4 w-4 text-violet-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                </div>
                <div class="flex-1 bg-white rounded-lg p-3 shadow-sm ring-1 ring-slate-900/5">
                    <p class="text-sm text-slate-700">Hi! I'm your AI audit assistant. I can help you:</p>
                    <ul class="mt-2 text-sm text-slate-600 space-y-1">
                        <li class="flex items-center gap-2"><span class="text-emerald-500">+</span> Add risks and controls to the RACM</li>
                        <li class="flex items-center gap-2"><span class="text-emerald-500">+</span> Create flowcharts for walkthroughs</li>
                        <li class="flex items-center gap-2"><span class="text-emerald-500">+</span> Create tasks on the audit plan</li>
                        <li class="flex items-center gap-2"><span class="text-emerald-500">+</span> Analyze and summarize your audit data</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div id="typingIndicator" class="hidden px-4 py-2 bg-slate-50">
            <div class="flex items-center gap-2 text-sm text-slate-500">
                <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
                Claude is thinking...
            </div>
        </div>

        <!-- Chat Input -->
        <div class="p-4 border-t border-slate-200 bg-white">
            <div class="flex gap-2">
                <input type="text" id="chatInput" placeholder="Ask about your audit..." onkeypress="handleChatKeypress(event)" class="flex-1 rounded-lg border-slate-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 text-sm">
                <button id="chatSend" onclick="sendMessage()" class="rounded-lg bg-violet-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-violet-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                    Send
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Backdrop -->
    <div id="chatBackdrop" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 hidden" onclick="toggleChat()"></div>

    <!-- Jspreadsheet JS -->
    <script src="https://bossanova.uk/jspreadsheet/v4/jspreadsheet.js"></script>
    <script src="https://jsuites.net/v5/jsuites.js"></script>

    <!-- SheetJS for Excel import/export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Quill.js for rich text editing -->
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

    <script>
        let table;  // RACM spreadsheet
        let issueTable;  // Issue Log spreadsheet
        let currentTab = 'racm';  // 'racm' or 'issues'

        // Get current active table
        function getActiveTable() {
            return currentTab === 'racm' ? table : issueTable;
        }

        // Switch between tabs
        function switchTab(tab) {
            currentTab = tab;

            // Update tab button styles
            document.getElementById('tab-racm').className = tab === 'racm'
                ? 'tab-button px-6 py-3 text-sm font-medium border-b-2 border-primary-500 text-primary-600 bg-white'
                : 'tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300';
            document.getElementById('tab-issues').className = tab === 'issues'
                ? 'tab-button px-6 py-3 text-sm font-medium border-b-2 border-primary-500 text-primary-600 bg-white'
                : 'tab-button px-6 py-3 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300';

            // Show/hide spreadsheets
            document.getElementById('spreadsheet-racm').style.display = tab === 'racm' ? 'block' : 'none';
            document.getElementById('spreadsheet-issues').style.display = tab === 'issues' ? 'block' : 'none';
        }

        // Initialize both spreadsheets
        async function init() {
            const response = await fetch('/api/data');
            const allData = await response.json();

            let racmData = allData.racm || [];
            let issuesData = allData.issues || [];

            // Skip header row if first row contains header text
            if (racmData.length > 0 && racmData[0][0] && typeof racmData[0][0] === 'string' &&
                racmData[0][0].toUpperCase().includes('RISK')) {
                racmData = racmData.slice(1);
            }

            const racmContainer = document.getElementById('spreadsheet-racm');
            const issuesContainer = document.getElementById('spreadsheet-issues');
            const containerWidth = racmContainer.parentElement.offsetWidth - 2;

            // Create RACM spreadsheet
            table = jspreadsheet(racmContainer, {
                data: racmData,
                columns: [
                    { type: 'text', width: 70, title: 'Risk ID' },
                    { type: 'text', width: 150, title: 'Risk', wordWrap: true },
                    { type: 'text', width: 80, title: 'Control ID' },
                    { type: 'text', width: 100, title: 'Control Owner' },
                    { type: 'text', width: 100, title: 'DE Testing', wordWrap: true },
                    { type: 'text', width: 100, title: 'DE Conclusion', wordWrap: true },
                    { type: 'text', width: 100, title: 'OE Testing', wordWrap: true },
                    { type: 'text', width: 100, title: 'OE Conclusion', wordWrap: true },
                    { type: 'dropdown', width: 100, title: 'Status', source: ['Effective', 'Not Effective', 'Not Complete'] },
                    { type: 'checkbox', width: 80, title: 'Ready for Review?' },
                    { type: 'text', width: 100, title: 'Reviewer' },
                    { type: 'checkbox', width: 80, title: 'Raise Issue?' },
                    { type: 'checkbox', width: 60, title: 'Closed' },
                    { type: 'text', width: 100, title: 'Flowchart' },
                    { type: 'text', width: 80, title: 'Task' },
                ],
                wordWrap: true,
                defaultRowHeight: 40,
                columnResize: true,
                rowResize: true,
                columnDrag: true,
                minDimensions: [15, 10],
                tableOverflow: true,
                tableWidth: containerWidth + 'px',
                tableHeight: 'auto',
                filters: true,
                search: true,
                updateTable: updateRACMTable,
                onchange: onRACMChange,
                contextMenu: function(obj, x, y, e) {
                    let items = [];
                    items.push({ title: 'Merge cells', onclick: function() { mergeSelected(); } });
                    items.push({ title: 'Unmerge cells', onclick: function() { unmergeSelected(); } });
                    items.push({ type: 'line' });
                    items.push({ title: 'Insert row above', onclick: function() { obj.insertRow(1, y, true); } });
                    items.push({ title: 'Insert row below', onclick: function() { obj.insertRow(1, y); } });
                    items.push({ title: 'Delete row', onclick: function() { obj.deleteRow(y); } });
                    items.push({ type: 'line' });
                    items.push({ title: 'Bold', onclick: function() { applyStyle('font-weight: bold;'); } });
                    items.push({ type: 'line' });
                    items.push({ title: 'Align Left', onclick: function() { setAlignment('left'); } });
                    items.push({ title: 'Align Center', onclick: function() { setAlignment('center'); } });
                    items.push({ title: 'Align Right', onclick: function() { setAlignment('right'); } });
                    items.push({ type: 'line' });
                    items.push({ title: 'Highlight Yellow', onclick: function() { applyStyle('background-color: #fef3c7;'); } });
                    items.push({ title: 'Highlight Green', onclick: function() { applyStyle('background-color: #d1fae5;'); } });
                    items.push({ title: 'Highlight Red', onclick: function() { applyStyle('background-color: #fee2e2;'); } });
                    items.push({ title: 'Clear style', onclick: function() { clearStyle(); } });
                    return items;
                }
            });

            // Create Issue Log spreadsheet
            issueTable = jspreadsheet(issuesContainer, {
                data: issuesData.length > 0 ? issuesData : [['', '', '', '', 'Medium', 'Open', '', '']],
                columns: [
                    { type: 'text', width: 80, title: 'Issue ID', readOnly: true },
                    { type: 'text', width: 80, title: 'Risk ID' },
                    { type: 'text', width: 200, title: 'Title' },
                    { type: 'text', width: 250, title: 'Description', wordWrap: true },
                    { type: 'dropdown', width: 100, title: 'Severity', source: ['Low', 'Medium', 'High', 'Critical'] },
                    { type: 'dropdown', width: 100, title: 'Status', source: ['Open', 'In Progress', 'Resolved', 'Closed'] },
                    { type: 'text', width: 120, title: 'Assigned To' },
                    { type: 'calendar', width: 100, title: 'Due Date', options: { format: 'YYYY-MM-DD' } },
                ],
                wordWrap: true,
                defaultRowHeight: 40,
                columnResize: true,
                rowResize: true,
                minDimensions: [8, 5],
                tableOverflow: true,
                tableWidth: containerWidth + 'px',
                tableHeight: 'auto',
                filters: true,
                search: true,
                updateTable: updateIssueTable,
                contextMenu: function(obj, x, y, e) {
                    let items = [];
                    items.push({ title: 'Insert row above', onclick: function() { obj.insertRow(1, y, true); } });
                    items.push({ title: 'Insert row below', onclick: function() { obj.insertRow(1, y); } });
                    items.push({ title: 'Delete row', onclick: function() { obj.deleteRow(y); } });
                    return items;
                }
            });

            return table;
        }

        // RACM sheet updateTable callback
        function updateRACMTable(instance, cell, col, row, val, label, cellName) {
            const riskId = instance.jexcel.getValueFromCoords(0, row);

            // DE Testing column (E = index 4)
            if (col == 4) {
                if (riskId && riskId.trim()) {
                    const cacheKey = `${riskId}_de_testing`;
                    const hasDoc = testDocCache[cacheKey] === true;
                    if (hasDoc) {
                        cell.innerHTML = '<span class="edit-test-doc text-emerald-600 hover:text-emerald-800 cursor-pointer text-sm font-medium" data-row="' + row + '" data-type="de_testing" data-risk="' + riskId + '">ðŸ“„ Edit</span>';
                    } else {
                        cell.innerHTML = '<span class="create-test-doc text-emerald-600 hover:text-emerald-800 cursor-pointer text-sm" data-row="' + row + '" data-type="de_testing" data-risk="' + riskId + '">+ Create</span>';
                    }
                }
            }
            // OE Testing column (G = index 6)
            if (col == 6) {
                if (riskId && riskId.trim()) {
                    const cacheKey = `${riskId}_oe_testing`;
                    const hasDoc = testDocCache[cacheKey] === true;
                    if (hasDoc) {
                        cell.innerHTML = '<span class="edit-test-doc text-emerald-600 hover:text-emerald-800 cursor-pointer text-sm font-medium" data-row="' + row + '" data-type="oe_testing" data-risk="' + riskId + '">ðŸ“„ Edit</span>';
                    } else {
                        cell.innerHTML = '<span class="create-test-doc text-emerald-600 hover:text-emerald-800 cursor-pointer text-sm" data-row="' + row + '" data-type="oe_testing" data-risk="' + riskId + '">+ Create</span>';
                    }
                }
            }
            // Flowchart column (N = index 13)
            if (col == 13) {
                if (val && val.trim()) {
                    cell.innerHTML = '<a href="/flowchart/' + encodeURIComponent(val) + '" target="_blank" class="text-primary-600 hover:text-primary-800 underline text-sm">' + val + '</a>';
                } else {
                    if (riskId && riskId.trim()) {
                        cell.innerHTML = '<span class="create-flowchart text-cyan-600 hover:text-cyan-800 cursor-pointer text-sm" data-row="' + row + '">+ Create</span>';
                    }
                }
            }
            // Task column (O = index 14)
            if (col == 14) {
                if (val && val.trim()) {
                    cell.innerHTML = '<span class="edit-task text-violet-600 hover:text-violet-800 cursor-pointer text-sm" data-task="' + val + '" data-row="' + row + '">Edit Task</span>';
                } else {
                    if (riskId && riskId.trim()) {
                        cell.innerHTML = '<span class="create-task text-violet-600 hover:text-violet-800 cursor-pointer text-sm" data-row="' + row + '">+ Add Task</span>';
                    }
                }
            }
            // Status column styling (I = index 8)
            if (col == 8) {
                const status = val ? val : '';
                if (status === 'Effective') {
                    cell.style.backgroundColor = '#d1fae5';
                    cell.style.color = '#065f46';
                } else if (status === 'Not Effective') {
                    cell.style.backgroundColor = '#fee2e2';
                    cell.style.color = '#991b1b';
                } else if (status === 'Not Complete') {
                    cell.style.backgroundColor = '#fef3c7';
                    cell.style.color = '#92400e';
                }
            }
        }

        // Issue Log sheet updateTable callback
        function updateIssueTable(instance, cell, col, row, val, label, cellName) {
            // Severity column styling (col 4)
            if (col == 4) {
                const severity = val ? val : '';
                if (severity === 'Critical') {
                    cell.style.backgroundColor = '#fee2e2';
                    cell.style.color = '#991b1b';
                } else if (severity === 'High') {
                    cell.style.backgroundColor = '#ffedd5';
                    cell.style.color = '#c2410c';
                } else if (severity === 'Medium') {
                    cell.style.backgroundColor = '#fef3c7';
                    cell.style.color = '#92400e';
                } else if (severity === 'Low') {
                    cell.style.backgroundColor = '#d1fae5';
                    cell.style.color = '#065f46';
                }
            }
            // Status column styling (col 5)
            if (col == 5) {
                const status = val ? val : '';
                if (status === 'Closed' || status === 'Resolved') {
                    cell.style.backgroundColor = '#d1fae5';
                    cell.style.color = '#065f46';
                } else if (status === 'In Progress') {
                    cell.style.backgroundColor = '#dbeafe';
                    cell.style.color = '#1e40af';
                } else if (status === 'Open') {
                    cell.style.backgroundColor = '#fee2e2';
                    cell.style.color = '#991b1b';
                }
            }
        }

        // Handle RACM changes - auto-create issue when checkbox ticked
        async function onRACMChange(instance, cell, x, y, value) {
            // Raise Issue? checkbox is column 11
            if (x == 11 && value === true) {
                const riskId = instance.jexcel.getValueFromCoords(0, y);
                if (riskId && riskId.trim()) {
                    try {
                        const response = await fetch(`/api/issues/from-risk/${encodeURIComponent(riskId)}`, {
                            method: 'POST'
                        });
                        const data = await response.json();
                        if (data.status === 'created') {
                            showToast(`Issue ${data.issue_id} created for ${riskId}`, 'success');
                            // Refresh the Issue Log tab
                            await refreshIssueLog();
                        } else if (data.status === 'exists') {
                            showToast(`Issue already exists for ${riskId}`, 'info');
                        }
                    } catch (error) {
                        console.error('Error creating issue:', error);
                    }
                }
            }
        }

        // Refresh just the Issue Log sheet
        async function refreshIssueLog() {
            const response = await fetch('/api/data');
            const allData = await response.json();
            if (issueTable) {
                const issuesData = allData.issues || [];
                issueTable.setData(issuesData.length > 0 ? issuesData : [['', '', '', '', 'Medium', 'Open', '', '']]);
            }
        }

        // Save data to server (both sheets)
        async function saveData() {
            const racmData = table.getData();
            const issuesData = issueTable.getData();
            await fetch('/api/data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ racm: racmData, issues: issuesData })
            });
            showToast('Data saved successfully!', 'success');
        }

        // Export to Excel (both sheets)
        function exportExcel() {
            const racmData = table.getData();
            const issuesData = issueTable.getData();
            const wb = XLSX.utils.book_new();

            // Add RACM sheet
            const racmWs = XLSX.utils.aoa_to_sheet(racmData);
            XLSX.utils.book_append_sheet(wb, racmWs, "RACM");

            // Add Issue Log sheet
            const issuesWs = XLSX.utils.aoa_to_sheet(issuesData);
            XLSX.utils.book_append_sheet(wb, issuesWs, "Issue Log");

            XLSX.writeFile(wb, "risk_control_matrix.xlsx");
            showToast('Exported to Excel!', 'success');
        }

        // Import from Excel
        function importExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });

                // Import RACM sheet
                if (workbook.SheetNames.includes('RACM')) {
                    const racmSheet = workbook.Sheets['RACM'];
                    const racmData = XLSX.utils.sheet_to_json(racmSheet, { header: 1 });
                    table.setData(racmData);
                } else if (workbook.SheetNames[0]) {
                    // Fallback to first sheet
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    table.setData(data);
                }

                // Import Issue Log sheet if present
                if (workbook.SheetNames.includes('Issue Log')) {
                    const issuesSheet = workbook.Sheets['Issue Log'];
                    const issuesData = XLSX.utils.sheet_to_json(issuesSheet, { header: 1 });
                    issueTable.setData(issuesData);
                }

                showToast('Imported from Excel!', 'success');
            };
            reader.readAsBinaryString(file);
            event.target.value = '';
        }

        function addRow() {
            const activeTable = getActiveTable();
            if (activeTable) activeTable.insertRow();
        }

        function mergeSelected() {
            // Get highlighted cells from the table
            const highlighted = table.getSelectedColumns();
            const selected = table.getSelectedRows();

            // Try to get selection from selectedCell property
            let sel = table.selectedCell;

            // If selectedCell doesn't have proper range, try to get from DOM
            if (!sel || sel.length < 4) {
                const selectedCells = document.querySelectorAll('#spreadsheet .jexcel tbody td.highlight');
                if (selectedCells.length > 1) {
                    let minX = Infinity, minY = Infinity, maxX = -1, maxY = -1;
                    selectedCells.forEach(cell => {
                        const x = parseInt(cell.dataset.x);
                        const y = parseInt(cell.dataset.y);
                        if (!isNaN(x) && !isNaN(y)) {
                            minX = Math.min(minX, x);
                            minY = Math.min(minY, y);
                            maxX = Math.max(maxX, x);
                            maxY = Math.max(maxY, y);
                        }
                    });
                    if (minX !== Infinity) {
                        sel = [minX, minY, maxX, maxY];
                    }
                }
            }

            if (sel && sel.length >= 4) {
                const x1 = Math.min(sel[0], sel[2]);
                const y1 = Math.min(sel[1], sel[3]);
                const x2 = Math.max(sel[0], sel[2]);
                const y2 = Math.max(sel[1], sel[3]);
                const colspan = x2 - x1 + 1;
                const rowspan = y2 - y1 + 1;

                if (colspan === 1 && rowspan === 1) {
                    showToast('Please select multiple cells to merge', 'warning');
                    return;
                }

                const cellName = jspreadsheet.getColumnNameFromId([x1, y1]);
                table.setMerge(cellName, colspan, rowspan);
                showToast('Cells merged!', 'success');
            } else {
                showToast('Please select multiple cells to merge (click and drag)', 'warning');
            }
        }

        function unmergeSelected() {
            let sel = table.selectedCell;
            if (!sel || sel.length < 2) {
                const selectedCell = document.querySelector('#spreadsheet .jexcel tbody td.highlight');
                if (selectedCell) {
                    const x = parseInt(selectedCell.dataset.x);
                    const y = parseInt(selectedCell.dataset.y);
                    if (!isNaN(x) && !isNaN(y)) {
                        sel = [x, y];
                    }
                }
            }
            if (sel && sel.length >= 2) {
                const cellName = jspreadsheet.getColumnNameFromId([sel[0], sel[1]]);
                table.removeMerge(cellName);
                showToast('Cells unmerged!', 'success');
            }
        }

        function applyStyle(style) {
            const sel = table.selectedCell;
            if (sel && sel.length === 4) {
                const x1 = Math.min(sel[0], sel[2]);
                const y1 = Math.min(sel[1], sel[3]);
                const x2 = Math.max(sel[0], sel[2]);
                const y2 = Math.max(sel[1], sel[3]);
                for (let y = y1; y <= y2; y++) {
                    for (let x = x1; x <= x2; x++) {
                        const cellEl = table.getCellFromCoords(x, y);
                        if (cellEl) {
                            cellEl.style.cssText += style;
                        }
                    }
                }
            }
        }

        function clearStyle() {
            const sel = table.selectedCell;
            if (sel && sel.length === 4) {
                const x1 = Math.min(sel[0], sel[2]);
                const y1 = Math.min(sel[1], sel[3]);
                const x2 = Math.max(sel[0], sel[2]);
                const y2 = Math.max(sel[1], sel[3]);
                for (let y = y1; y <= y2; y++) {
                    for (let x = x1; x <= x2; x++) {
                        const cellEl = table.getCellFromCoords(x, y);
                        if (cellEl) {
                            cellEl.style.cssText = '';
                        }
                    }
                }
            }
        }

        function setAlignment(align) {
            const sel = table.selectedCell;
            if (sel && sel.length === 4) {
                const x1 = Math.min(sel[0], sel[2]);
                const y1 = Math.min(sel[1], sel[3]);
                const x2 = Math.max(sel[0], sel[2]);
                const y2 = Math.max(sel[1], sel[3]);
                for (let y = y1; y <= y2; y++) {
                    for (let x = x1; x <= x2; x++) {
                        const cellEl = table.getCellFromCoords(x, y);
                        if (cellEl) {
                            cellEl.style.textAlign = align;
                        }
                    }
                }
            }
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast rounded-lg shadow-lg p-4 flex items-center gap-3 ${
                type === 'success' ? 'bg-emerald-600 text-white' :
                type === 'error' ? 'bg-red-600 text-white' :
                type === 'warning' ? 'bg-amber-500 text-white' :
                'bg-slate-700 text-white'
            }`;

            const icons = {
                success: '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />',
                error: '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />',
                warning: '<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />',
                info: '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />'
            };

            toast.innerHTML = `
                <svg class="h-5 w-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">${icons[type] || icons.info}</svg>
                <p class="text-sm font-medium flex-1">${message}</p>
                <button onclick="this.parentElement.remove()" class="text-white/70 hover:text-white">
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // Initialize on load
        init().then(() => {
            // Load test document status after table is ready
            setTimeout(() => loadTestDocStatus(), 500);
        });

        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                if (table) {
                    const container = document.getElementById('spreadsheet');
                    const containerWidth = container.parentElement.offsetWidth - 2;
                    // Update table width
                    const tableEl = container.querySelector('.jexcel_container');
                    if (tableEl) {
                        tableEl.style.width = containerWidth + 'px';
                    }
                }
            }, 150);
        });

        // Handle click events for spreadsheet links
        document.getElementById('spreadsheet').addEventListener('click', function(e) {
            if (e.target.classList.contains('create-flowchart')) {
                const row = parseInt(e.target.getAttribute('data-row'));
                const riskId = table.getValueFromCoords(0, row);
                if (riskId) {
                    const flowchartName = riskId.replace(/\s+/g, '-').toLowerCase() + '-walkthrough';
                    table.setValueFromCoords(13, row, flowchartName);
                    window.open('/flowchart/' + encodeURIComponent(flowchartName), '_blank');
                    saveData();
                }
            }
            if (e.target.classList.contains('create-task')) {
                const row = parseInt(e.target.getAttribute('data-row'));
                openTaskModal(row, null);
            }
            if (e.target.classList.contains('edit-task')) {
                const row = parseInt(e.target.getAttribute('data-row'));
                const taskId = e.target.getAttribute('data-task');
                openTaskModal(row, taskId);
            }
            // Test Document handlers
            if (e.target.classList.contains('create-test-doc') || e.target.classList.contains('edit-test-doc')) {
                const row = parseInt(e.target.getAttribute('data-row'));
                const docType = e.target.getAttribute('data-type');
                const riskCode = e.target.getAttribute('data-risk');
                openTestDocModal(row, riskCode, docType);
            }
        });

        // Task Modal Functions
        async function openTaskModal(row, taskId) {
            const riskId = table.getValueFromCoords(0, row);
            const riskDesc = table.getValueFromCoords(1, row);
            const controlDesc = table.getValueFromCoords(2, row);

            document.getElementById('taskRow').value = row;
            document.getElementById('taskId').value = taskId || '';

            if (taskId) {
                document.getElementById('taskModalTitle').textContent = 'Edit Task';
                const response = await fetch(`/api/kanban/default/task/${taskId}`);
                const task = await response.json();
                if (task) {
                    document.getElementById('taskTitle').value = task.title || '';
                    document.getElementById('taskDescription').value = task.description || '';
                    document.getElementById('taskPriority').value = task.priority || 'medium';
                    document.getElementById('taskAssignee').value = task.assignee || '';
                    document.getElementById('taskDueDate').value = task.dueDate || '';
                    document.getElementById('taskStatus').classList.remove('hidden');
                    document.getElementById('taskStatusText').textContent = task.columnTitle || 'Unknown';
                    document.getElementById('viewOnBoardLink').classList.remove('hidden');
                }
            } else {
                document.getElementById('taskModalTitle').textContent = 'Add Task';
                document.getElementById('taskTitle').value = `Test: ${riskId} - ${controlDesc || riskDesc}`.substring(0, 100);
                document.getElementById('taskDescription').value = `Risk: ${riskDesc}\nControl: ${controlDesc}`;
                document.getElementById('taskPriority').value = 'medium';
                document.getElementById('taskAssignee').value = '';
                document.getElementById('taskDueDate').value = '';
                document.getElementById('taskStatus').classList.add('hidden');
                document.getElementById('viewOnBoardLink').classList.add('hidden');
            }

            document.getElementById('taskModal').classList.remove('hidden');
            document.getElementById('taskModal').classList.add('flex');
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.add('hidden');
            document.getElementById('taskModal').classList.remove('flex');
        }

        async function saveTask() {
            const row = parseInt(document.getElementById('taskRow').value);
            const taskId = document.getElementById('taskId').value;
            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const priority = document.getElementById('taskPriority').value;
            const assignee = document.getElementById('taskAssignee').value.trim();
            const dueDate = document.getElementById('taskDueDate').value;

            if (!title) {
                showToast('Please enter a title', 'warning');
                return;
            }

            const riskId = table.getValueFromCoords(0, row);
            const taskData = { title, description, priority, assignee, dueDate, riskId, racmRow: row };

            if (taskId) {
                await fetch(`/api/kanban/default/task/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });
                showToast('Task updated!', 'success');
            } else {
                const response = await fetch('/api/kanban/default/task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });
                const result = await response.json();
                table.setValueFromCoords(14, row, result.taskId);
                await saveData();
                showToast('Task created!', 'success');
            }
            closeTaskModal();
        }

        document.getElementById('taskModal').addEventListener('click', function(e) {
            if (e.target === this) closeTaskModal();
        });

        // ==================== Test Document Editor Functions ====================
        let quillEditor = null;
        let testDocCache = {}; // Cache for document existence status

        async function checkTestDocExists(riskCode, docType) {
            const cacheKey = `${riskCode}_${docType}`;
            if (testDocCache[cacheKey] !== undefined) {
                return testDocCache[cacheKey];
            }
            try {
                const response = await fetch(`/api/test-document/${encodeURIComponent(riskCode)}/${docType}/exists`);
                const data = await response.json();
                testDocCache[cacheKey] = data.exists;
                return data.exists;
            } catch (e) {
                return false;
            }
        }

        async function loadTestDocStatus() {
            // Load document status for all rows into cache, then refresh table
            const data = table.getData();
            for (let row = 0; row < data.length; row++) {
                const riskCode = data[row][0];
                if (riskCode && riskCode.trim()) {
                    // Pre-populate cache for DE and OE Testing columns
                    await checkTestDocExists(riskCode, 'de_testing');
                    await checkTestDocExists(riskCode, 'oe_testing');
                }
            }
            // Refresh the table to update the cell rendering (uses cache)
            table.refresh();
        }

        async function openTestDocModal(row, riskCode, docType) {
            const riskDesc = table.getValueFromCoords(1, row);
            const typeLabel = docType === 'de_testing' ? 'Design Effectiveness Testing' : 'Operational Effectiveness Testing';

            document.getElementById('testDocModalTitle').textContent = typeLabel;
            document.getElementById('testDocModalSubtitle').textContent = `Risk: ${riskCode} - ${riskDesc || 'No description'}`;
            document.getElementById('testDocRiskCode').value = riskCode;
            document.getElementById('testDocType').value = docType;

            // Initialize Quill if not already done
            if (!quillEditor) {
                quillEditor = new Quill('#testDocEditor', {
                    theme: 'snow',
                    placeholder: 'Document your testing procedures, findings, and evidence...',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'indent': '-1'}, { 'indent': '+1' }],
                            ['blockquote', 'code-block'],
                            ['link'],
                            ['clean']
                        ]
                    }
                });
            }

            // Load existing content
            try {
                const response = await fetch(`/api/test-document/${encodeURIComponent(riskCode)}/${docType}`);
                const data = await response.json();
                if (data.content) {
                    quillEditor.root.innerHTML = data.content;
                } else {
                    quillEditor.root.innerHTML = '';
                }
            } catch (e) {
                quillEditor.root.innerHTML = '';
            }

            document.getElementById('testDocModal').classList.remove('hidden');
            document.getElementById('testDocModal').classList.add('flex');
        }

        function closeTestDocModal() {
            document.getElementById('testDocModal').classList.add('hidden');
            document.getElementById('testDocModal').classList.remove('flex');
        }

        async function saveTestDocument() {
            const riskCode = document.getElementById('testDocRiskCode').value;
            const docType = document.getElementById('testDocType').value;
            const content = quillEditor.root.innerHTML;

            try {
                const response = await fetch(`/api/test-document/${encodeURIComponent(riskCode)}/${docType}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                const data = await response.json();

                if (data.status === 'saved') {
                    showToast('Document saved successfully!', 'success');
                    // Update cache and refresh cells
                    testDocCache[`${riskCode}_${docType}`] = content.trim().length > 0;
                    await loadTestDocStatus();
                    closeTestDocModal();
                } else {
                    showToast('Error saving document: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                showToast('Error saving document: ' + e.message, 'error');
            }
        }

        document.getElementById('testDocModal').addEventListener('click', function(e) {
            if (e.target === this) closeTestDocModal();
        });

        // ==================== Chat Functions ====================
        let chatOpen = false;

        function toggleChat() {
            chatOpen = !chatOpen;
            const panel = document.getElementById('chatPanel');
            const backdrop = document.getElementById('chatBackdrop');

            if (chatOpen) {
                panel.classList.remove('translate-x-full');
                backdrop.classList.remove('hidden');
                document.getElementById('chatInput').focus();
            } else {
                panel.classList.add('translate-x-full');
                backdrop.classList.add('hidden');
            }
        }

        function handleChatKeypress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addChatMessage(message, 'user');
            input.value = '';

            document.getElementById('typingIndicator').classList.remove('hidden');
            document.getElementById('chatSend').disabled = true;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const data = await response.json();

                if (data.error) {
                    addChatMessage(data.error, 'error');
                } else {
                    addChatMessage(data.response, 'assistant');
                    if (data.data_version !== undefined) {
                        await refreshSpreadsheet();
                    }
                }
            } catch (error) {
                addChatMessage('Failed to connect: ' + error.message, 'error');
            }

            document.getElementById('typingIndicator').classList.add('hidden');
            document.getElementById('chatSend').disabled = false;
        }

        async function refreshSpreadsheet() {
            const response = await fetch('/api/data');
            const data = await response.json();
            table.setData(data);
        }

        function addChatMessage(content, type) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex gap-3';

            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex-1"></div>
                    <div class="bg-violet-600 text-white rounded-lg p-3 max-w-[80%]">
                        <p class="text-sm">${escapeHtml(content)}</p>
                    </div>
                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-slate-200 flex items-center justify-center">
                        <svg class="h-4 w-4 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                `;
            } else if (type === 'error') {
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-red-100 flex items-center justify-center">
                        <svg class="h-4 w-4 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <div class="flex-1 bg-red-50 border border-red-200 rounded-lg p-3">
                        <p class="text-sm text-red-700">${escapeHtml(content)}</p>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-violet-100 flex items-center justify-center">
                        <svg class="h-4 w-4 text-violet-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <div class="flex-1 bg-white rounded-lg p-3 shadow-sm ring-1 ring-slate-900/5">
                        <div class="text-sm text-slate-700 prose prose-sm max-w-none">${formatMarkdown(content)}</div>
                    </div>
                `;
            }
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMarkdown(text) {
            let html = escapeHtml(text);
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/`(.*?)`/g, '<code class="bg-slate-100 px-1 rounded text-xs">$1</code>');
            html = html.replace(/\n\n/g, '</p><p class="mt-2">');
            html = html.replace(/\n/g, '<br>');
            html = html.replace(/^- (.*?)(<br>|$)/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)+/g, '<ul class="list-disc list-inside mt-1 space-y-1">$&</ul>');
            return `<p>${html}</p>`;
        }

        async function clearChat() {
            document.getElementById('chatMessages').innerHTML = `
                <div class="flex gap-3">
                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-violet-100 flex items-center justify-center">
                        <svg class="h-4 w-4 text-violet-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <div class="flex-1 bg-white rounded-lg p-3 shadow-sm ring-1 ring-slate-900/5">
                        <p class="text-sm text-slate-700">Chat cleared. How can I help with your audit?</p>
                    </div>
                </div>
            `;
            await fetch('/api/chat/clear', { method: 'POST' });
        }

        // Escape key closes chat
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && chatOpen) toggleChat();
        });
    </script>
</body>
</html>
